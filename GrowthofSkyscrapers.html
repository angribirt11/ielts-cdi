<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Reading Passage 3 ‚Äì Building the Skyline: The Birth and Growth of Manhattan's Skyscrapers</title>
<style>
  :root{--brand:#2563eb;--ink:#111827;--bg:#f7f7fb;--ok:#16a34a;--bad:#dc2626;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .container{display:flex;gap:20px;max-width:1200px;margin:0 auto;padding:20px 20px 96px}
  .card{background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:20px;overflow:auto;max-height:90vh}
  .passage{flex:1}
  .questions{flex:1}
  h1{color:var(--ink);border-bottom:2px solid var(--brand);padding-bottom:10px;margin:0 0 14px}
  h2{color:var(--brand);margin:22px 0 10px}
  h3{margin:8px 0 0}
  .muted{color:var(--muted)}

  /* Timer */
  .timerWrap{position:fixed;top:16px;right:16px;display:flex;align-items:center;gap:8px;z-index:10}
  .timer{background:var(--brand);color:#fff;padding:10px 14px;border-radius:8px;font-weight:700}
  .tbtn{border:1px solid #e5e7eb;background:#fff;color:#111;padding:8px 10px;border-radius:8px;cursor:pointer}

  /* Questions */
  .qsection{margin:14px 0 6px}
  .qblock{padding:14px;border:1px solid #e5e7eb;border-radius:12px;margin:12px 0}
  .qhead{font-weight:600;margin-bottom:8px}
  .options{margin-top:8px}
  .options label{display:block;margin:6px 0}
  select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;max-width:520px}
  .submit{background:var(--brand);color:#fff;border:0;padding:12px 18px;border-radius:8px;cursor:pointer;font-size:16px;margin-top:16px}
  .submit:hover{filter:brightness(.95)}

  /* Results */
  .results{display:none;margin-top:18px;background:#f8f9fa;border-radius:10px;padding:16px}
  .results ul{list-style:none;padding:0;margin:8px 0 0}
  .results li{margin:6px 0;padding:8px;border-radius:8px}
  .results li.ok{background:#ecfdf5;color:#065f46}
  .results li.bad{background:#fef2f2;color:#991b1b}
  .results .meta{font-size:13px;color:var(--muted)}

  /* Footer chips */
  .footerNav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;z-index:9}
  .chip{border:1px solid #d1d5db;background:#fff;color:#111;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:14px}
  .chip.answered{border-color:#9ca3af;background:#f3f4f6}

  /* Highlights */
  .palette{position:fixed;background:#fff;padding:8px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.12);display:none;z-index:9}
  .hbtn{background:var(--brand);color:#fff;border:0;padding:6px 10px;border-radius:6px;margin:4px 4px 0 0;cursor:pointer}
  .highlight{background:yellow}

  .tg{position:fixed;bottom:96px;right:16px;background:#0088cc;color:#fff;border:0;padding:12px 16px;border-radius:9999px;display:flex;align-items:center;gap:8px;cursor:pointer;box-shadow:0 8px 20px rgba(0,136,204,.35)}
</style>
</head>
<body>
  <div class="timerWrap">
    <div class="timer" id="timer">20:00</div>
    <button class="tbtn" id="pauseBtn">‚è∏Ô∏è Pause</button>
    <button class="tbtn" id="resumeBtn" disabled>‚ñ∂Ô∏è Resume</button>
  </div>

  <!-- Highlight palettes -->
  <div class="palette" id="pPalette">
    <button class="hbtn" data-color="yellow">Yellow</button>
    <button class="hbtn" data-color="lightgreen">Green</button>
    <button class="hbtn" data-color="lightblue">Blue</button>
    <button class="hbtn" data-color="pink">Pink</button>
    <button class="hbtn" data-color="orange">Orange</button>
    <button class="hbtn" id="clearPMarks">Clear</button>
  </div>
  <div class="palette" id="qPalette">
    <button class="hbtn" data-color="yellow">Yellow</button>
    <button class="hbtn" data-color="lightgreen">Green</button>
    <button class="hbtn" data-color="lightblue">Blue</button>
    <button class="hbtn" data-color="pink">Pink</button>
    <button class="hbtn" data-color="orange">Orange</button>
    <button class="hbtn" id="clearQMarks">Clear</button>
  </div>

  <div class="container">
    <div class="card passage" id="passageCard">
      <h1 id="title"></h1>
      <div id="subtitle" class="muted"></div>

      <div id="passage">
        <h2>Reading Passage 3</h2>
        <h3>Building the Skyline: The Birth and Growth of Manhattan's Skyscrapers</h3>
        <p class="muted"><em>Katharine L. Shester reviews a book by Jason Barr about the development of New York City</em></p>

        <p>In <em>Building the Skyline</em>, <strong>Jason Barr</strong> takes the reader through a detailed history of New York City. The book combines geology, history, economics, and a lot of data to explain why business clusters developed where they did and how the early decisions of workers and firms shaped the skyline we see today. <em>Building the Skyline</em> is organized into two distinct parts. The first is primarily historical and addresses New York's settlement and growth from 1609 to 1900; the second deals primarily with the 20th century and is a compilation of chapters commenting on different aspects of New York's urban development. The tone and organization of the book changes somewhat between the first and second parts, as the latter chapters incorporate aspects of Barr's related research papers.</p>

        <p>Barr begins chapter one by taking the reader on a '<strong>helicopter time-machine</strong>' ride ‚Äî giving a fascinating account of how the New York landscape in 1609 might have looked from the sky. He then moves on to a subterranean walking tour of the city, indicating the location of rock and water below the subsoil, before taking the reader back to the surface. His love of the city comes through as he describes various fun facts about the location of the New York residence of early 19th-century vice-president <strong>Aaron Burr</strong> as well as a number of legends about the city.</p>

        <p>Chapters two and three take the reader up to the <strong>Civil War (1861-1865)</strong>, with chapter two focusing on the early development of land and the implementation of a <strong>grid system in 1811</strong>. Chapter three focuses on land use before the Civil War. Both chapters are informative and well researched and set the stage for the economic analysis that comes later in the book. I would have liked Barr to expand upon his claim that existing <strong>tenements</strong>* prevented skyscrapers in certain neighborhoods because 'likely no skyscraper developer was interested in performing the necessary "slum clearance"'. Later in the book, Barr makes the claim that the depth of <strong>bedrock</strong>** was not a limiting factor for developers, as foundation costs were a small fraction of the cost of development. At first glance, it is not obvious why slum clearance would be limiting, while more expensive foundations would not.</p>

        <p>Chapter four focuses on immigration and the location of neighborhoods and tenements in the late 19th century. Barr identifies four primary immigrant enclaves and analyzes their locations in terms of the amenities available in the area. Most of these enclaves were located on the least valuable land, between the industries located on the waterfront and the wealthy neighborhoods bordering <strong>Central Park</strong>.</p>

        <p>Part two of the book begins with a discussion of the economics of skyscraper height. In chapter five, Barr distinguishes between <strong>engineering height</strong>, <strong>economic height</strong>, and <strong>developer height</strong> ‚Äî where engineering height is the tallest building that can be safely made at a given time, economic height is the height that is most efficient from society's point of view, and developer height is the actual height chosen by the developer, who is attempting to maximize return on investment.</p>

        <p>Chapter five also has an interesting discussion of the technological advances that led to the construction of skyscrapers. For example, the introduction of <strong>iron and steel skeletal frames</strong> made thick, load-bearing walls unnecessary, expanding the usable square footage of buildings and increasing the use of windows and availability of natural light. Chapter six then presents data on building height throughout the 20th century and uses regression analysis to 'predict' building construction. While less technical than the research paper on which the chapter is based, it is probably more technical than would be preferred by a general audience.</p>

        <p>Chapter seven tackles the '<strong>bedrock myth</strong>', the assumption that the absence of bedrock close to the surface between Downtown and Midtown New York is the reason for skyscrapers not being built between the two urban centers. Rather, Barr argues that while deeper bedrock does increase foundation costs, these costs were neither prohibitively high nor were they large compared to the overall cost of building a skyscraper. What I enjoyed the most about this chapter was Barr's discussion of how foundations are actually built. He describes the use of <strong>caissons</strong>, which enable workers to dig down for considerable distances, often below the water table, until they reach bedrock. Barr's thorough technological history discusses not only how caissons work, but also the dangers involved. While this chapter references empirical research papers, it is a relatively easy read.</p>

        <p>Chapters eight and nine focus on the birth of Midtown and the building boom of the 1920s. Chapter eight contains lengthy discussions of urban economic theory that may serve as a distraction to readers primarily interested in New York. However, they would be well-suited for undergraduates learning about the economics of cities. In the next chapter, Barr considers two of the primary explanations for the building boom of the 1920s ‚Äî the first being exuberance, and the second being financing. He uses data to assess the viability of these two explanations and finds that supply and demand factors explain much of the development of the 1920s; though it enabled the boom, cheap credit was not, he argues, the primary cause.</p>

        <p>In the final chapter (chapter 10), Barr discusses another of his empirical papers that estimates Manhattan land values from the mid-19th century to the present day. The data work that went into these estimations is particularly impressive. Toward the end of the chapter, Barr assesses 'whether skyscrapers are a cause or an effect of high land values'. He finds that changes in land values predict future building height, but the reverse is not true. The book ends with an epilogue, in which Barr discusses the impact of climate change on the city and makes policy suggestions for New York going forward.</p>

        <p class="muted">*a tenement: a multi-occupancy building of any sort, but particularly a run-down apartment building or slum building</p>
        <p class="muted">**bedrock: the solid, hard rock in the ground that lies under a loose layer of soil</p>
      </div>
    </div>

    <div class="card questions">
      <h1>Questions</h1>
      <div id="qroot"></div>
      <button class="submit" id="submitBtn">Submit Answers</button>
      <div class="results" id="results">
        <h2>Your Results</h2>
        <div id="score" class="meta"></div>
        <ul id="answers"></ul>
      </div>
    </div>
  </div>

  <div class="footerNav" id="footerNav"></div>
  <button class="tg" id="tgBtn">üì¢ Join my Telegram</button>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  title: "READING PASSAGE 3 ‚Äì Building the Skyline: The Birth and Growth of Manhattan's Skyscrapers",
  subtitle: "You should spend about 20 minutes on Questions 27‚Äì40.",
  durationMinutes: 20,
  telegramLink: "https://t.me/yourchannel",
  showFooterNavigator: true,

  sections: [
    /* 27‚Äì31 Multiple choice */
    {
      type: "mcq",
      heading: "Questions 27‚Äì31",
      instructions: ["Choose the correct letter, A, B, C or D.", "Write the correct letter in boxes 27‚Äì31 on your answer sheet."],
      items: [
        { 
          id: 27, 
          text: "What point does Shester make about Barr's book in the first paragraph?", 
          options: {
            A: "It gives a highly original explanation for urban development.",
            B: "Elements of Barr's research papers are incorporated throughout the book.",
            C: "Other books that are available on the subject have taken a different approach.",
            D: "It covers a range of factors that affected the development of New York."
          }, 
          correct: "D" 
        },
        { 
          id: 28, 
          text: "How does Shester respond to the information in the book about tenements?", 
          options: {
            A: "She describes the reasons for Barr's interest.",
            B: "She indicates a potential problem with Barr's analysis.",
            C: "She compares Barr's conclusion with that of other writers.",
            D: "She provides details about the sources Barr used for his research."
          }, 
          correct: "B" 
        },
        { 
          id: 29, 
          text: "What does Shester say about chapter six of the book?", 
          options: {
            A: "It contains conflicting data.",
            B: "It focuses too much on possible trends.",
            C: "It is too specialised for most readers.",
            D: "It draws on research that is out of date."
          }, 
          correct: "C" 
        },
        { 
          id: 30, 
          text: "What does Shester suggest about the chapters focusing on the 1920s building boom?", 
          options: {
            A: "The information should have been organised differently.",
            B: "More facts are needed about the way construction was financed.",
            C: "The explanation that is given for the building boom is unlikely.",
            D: "Some parts will have limited appeal to certain people."
          }, 
          correct: "D" 
        },
        { 
          id: 31, 
          text: "What impresses Shester the most about the chapter on land values?", 
          options: {
            A: "the broad time period that is covered",
            B: "the interesting questions that Barr asks",
            C: "the nature of the research into the topic",
            D: "the recommendations Barr makes for the future"
          }, 
          correct: "C" 
        }
      ]
    },

    /* 32‚Äì35 YES/NO/NOT GIVEN */
    {
      type: "yesno",
      heading: "Questions 32‚Äì35",
      instructions: ["Do the following statements agree with the claims of the writer in Reading Passage 3?", "In boxes 32‚Äì35 on your answer sheet, write", "YES if the statement agrees with the claims of the writer", "NO if the statement contradicts the claims of the writer", "NOT GIVEN if it is impossible to say what the writer thinks about this"],
      items: [
        { id: 32, text: "The description in the first chapter of how New York probably looked from the air in the early 1600s lacks interest.", correct: "NO" },
        { id: 33, text: "Chapters two and three prepare the reader well for material yet to come.", correct: "YES" },
        { id: 34, text: "The biggest problem for many nineteenth-century New York immigrant neighbourhoods was a lack of amenities.", correct: "NOT GIVEN" },
        { id: 35, text: "In the nineteenth century, New York's immigrant neighbourhoods tended to concentrate around the harbour.", correct: "YES" }
      ]
    },

    /* 36‚Äì40 Summary completion */
    {
      type: "summary",
      heading: "Questions 36‚Äì40",
      instructions: ["Complete the summary using the list of phrases, A‚ÄìJ, below.", "Write the correct letter, A‚ÄìJ, in boxes 36‚Äì40 on your answer sheet."],
      summaryText: "The bedrock myth\n\nIn chapter seven, Barr indicates how the lack of bedrock close to the surface does not explain why skyscrapers are absent from 36. ........................ He points out that although the cost of foundations increases when bedrock is deep below the surface, this cannot be regarded as 37. ........................, especially when compared to 38. ........................\n\nA particularly enjoyable part of the chapter was Barr's account of how foundations are built. He describes not only how 39. ........................ are made possible by the use of caissons, but he also discusses their 40. ........................ The chapter is well researched but relatively easy to understand.",
      phraseOptions: {
        A: "development plans",
        B: "deep excavations", 
        C: "great distance",
        D: "excessive expense",
        E: "impossible tasks",
        F: "associated risks",
        G: "water level",
        H: "specific areas",
        I: "total expenditure",
        J: "construction guidelines"
      },
      items: [
        { id: 36, correct: "H" },
        { id: 37, correct: "D" },
        { id: 38, correct: "I" },
        { id: 39, correct: "B" },
        { id: 40, correct: "F" }
      ]
    }
  ]
};

/* =======================
   RENDER
   ======================= */
document.getElementById('title').textContent = CONFIG.title;
document.getElementById('subtitle').textContent = CONFIG.subtitle || '';

const qroot = document.getElementById('qroot');
const navIds = [];
const answersMap = {};

function sectionHeader(t){ const h=document.createElement('h2'); h.className='qsection'; h.textContent=t; return h; }

/* MCQ renderer */
function renderMCQ(sec){
  qroot.appendChild(sectionHeader(sec.heading));
  (sec.instructions||[]).forEach(tx=>{ const p=document.createElement('p'); p.className='muted'; p.textContent=tx; qroot.appendChild(p); });
  sec.items.forEach(it=>{
    const b=document.createElement('div'); b.className='qblock'; b.id=`anchor-${it.id}`;
    const opts=Object.entries(it.options).map(([k,v])=>`<label><input type="radio" name="q${it.id}" value="${k}"> <strong>${k}</strong> ${v}</label>`).join('');
    b.innerHTML=`<div class="qhead"><strong>${it.id}.</strong> ${it.text}</div><div class="options">${opts}</div>`;
    qroot.appendChild(b); navIds.push(it.id); answersMap[it.id]=it.correct||'';
  });
}

/* YES/NO/NOT GIVEN renderer */
function renderYesNo(sec){
  qroot.appendChild(sectionHeader(sec.heading));
  (sec.instructions||[]).forEach(tx=>{ const p=document.createElement('p'); p.className='muted'; p.textContent=tx; qroot.appendChild(p); });
  sec.items.forEach(it=>{
    const b=document.createElement('div'); b.className='qblock'; b.id=`anchor-${it.id}`;
    const opts=['YES','NO','NOT GIVEN'].map(v=>`<label><input type="radio" name="q${it.id}" value="${v}"> ${v}</label>`).join('');
    b.innerHTML=`<div class="qhead"><strong>${it.id}.</strong> ${it.text}</div><div class="options">${opts}</div>`;
    qroot.appendChild(b); navIds.push(it.id); answersMap[it.id]=it.correct||'';
  });
}

/* Summary completion renderer */
function renderSummary(sec){
  qroot.appendChild(sectionHeader(sec.heading));
  (sec.instructions||[]).forEach(tx=>{ const p=document.createElement('p'); p.className='muted'; p.textContent=tx; qroot.appendChild(p); });
  
  const summaryBlock=document.createElement('div'); summaryBlock.className='qblock';
  let summaryContent = sec.summaryText;
  
  sec.items.forEach(item => {
    const placeholder = `${item.id}. ........................`;
    if (summaryContent.includes(placeholder)) {
      summaryContent = summaryContent.replace(placeholder, `<select id="q${item.id}" name="q${item.id}"><option value="">‚Äî</option>${Object.entries(sec.phraseOptions).map(([key, value]) => `<option value="${key}">${key} - ${value}</option>`).join('')}</select>`);
      navIds.push(item.id);
      answersMap[item.id] = item.correct || '';
    }
  });
  
  summaryBlock.innerHTML = summaryContent.replace(/\n/g, '<br>');
  qroot.appendChild(summaryBlock);

  // Add phrase options display
  const optionsBlock=document.createElement('div'); optionsBlock.className='qblock';
  optionsBlock.innerHTML = `<div class="qhead"><strong>Phrase Options</strong></div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
      ${Object.entries(sec.phraseOptions).map(([key, value]) => `<div><strong>${key}</strong> - ${value}</div>`).join('')}
    </div>`;
  qroot.appendChild(optionsBlock);
}

/* Build UI */
CONFIG.sections.forEach(sec=>{
  if (sec.type==='mcq') renderMCQ(sec);
  if (sec.type==='yesno') renderYesNo(sec);
  if (sec.type==='summary') renderSummary(sec);
});

/* Footer chips */
const footerNav=document.getElementById('footerNav');
(function(){
  if(!CONFIG.showFooterNavigator){ footerNav.style.display='none'; return; }
  footerNav.innerHTML='<strong class="muted">Questions:</strong>';
  [...new Set(navIds)].sort((a,b)=>a-b).forEach(id=>{
    const chip=document.createElement('button'); chip.className='chip'; chip.id=`chip-${id}`; chip.textContent=id;
    chip.addEventListener('click',()=>{ 
      const anchor = document.getElementById(`anchor-${id}`);
      if (anchor) {
        anchor.scrollIntoView({behavior:'smooth',block:'center'}); 
      }
    });
    footerNav.appendChild(chip);
  });
})();

function markChipAnswered(id, answered){
  const chip=document.getElementById(`chip-${id}`); if(chip) chip.classList.toggle('answered', !!answered);
}

document.addEventListener('change',(e)=>{
  const m=String(e.target.name||e.target.id||'').match(/q(\d+)/);
  const id=m?+m[1]:null; if(!id) return;
  const answered=(e.target.type==='radio') ? (!!document.querySelector(`input[name='q${id}']:checked`))
                 : (e.target.value.trim().length>0);
  markChipAnswered(id, answered);
});

/* Timer */
let timeLeft=Math.max(1,+CONFIG.durationMinutes||20)*60;
const timer=document.getElementById('timer');
const pauseBtn=document.getElementById('pauseBtn');
const resumeBtn=document.getElementById('resumeBtn');
let paused=false, iv;
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
function startTick(){ if(iv) clearInterval(iv);
  iv=setInterval(()=>{ if(paused) return; timer.textContent=fmt(timeLeft); if(timeLeft<=0){ clearInterval(iv); alert("Time's up! Submitting."); submit(); } timeLeft--; },1000);
}
timer.textContent=fmt(timeLeft); startTick();
pauseBtn.addEventListener('click',()=>{ paused=true; pauseBtn.disabled=true; resumeBtn.disabled=false; });
resumeBtn.addEventListener('click',()=>{ paused=false; pauseBtn.disabled=false; resumeBtn.disabled=true; });

/* Submit & grading */
document.getElementById('submitBtn').addEventListener('click', submit);
function submit(){
  paused=true; pauseBtn.disabled=true; resumeBtn.disabled=false;
  let total=0, graded=0, correctCount=0;
  const itemsOut=[];
  const ids=Object.keys(answersMap);

  ids.forEach(key=>{
    const ans=answersMap[key];
    const label=key;
    let user='';
    const picked=document.querySelector(`input[name="q${key}"]:checked`);
    if(picked){ user=picked.value; }
    else if(document.getElementById('q'+key)){ user=document.getElementById('q'+key).value; }
    const shown=user||'No answer';

    if(String(ans).trim()===''){ total++; itemsOut.push({label, status:'‚Äî not graded ‚Äî', user:shown, correct:'(no key)'}); return; }

    total++; graded++;
    const ok = shown.trim().toUpperCase() === String(ans).trim().toUpperCase();
    if(ok) correctCount++;
    itemsOut.push({label, status: ok? '‚úì Correct' : '‚úó Incorrect', user:shown, correct:String(ans)});
  });

  document.getElementById('score').innerHTML = `Graded ${graded} of ${total} ‚Ä¢ Score: ${correctCount}/${graded}`;
  document.getElementById('answers').innerHTML = itemsOut.sort((a,b) => parseInt(a.label) - parseInt(b.label)).map(it=>`<li class="${/Correct/.test(it.status)?'ok':'bad'}">Q${it.label}: ${it.status} ‚Äî Your: <b>${it.user}</b> | Correct: <b>${it.correct}</b></li>`).join('');
  const r=document.getElementById('results'); r.style.display='block'; r.scrollIntoView({behavior:'smooth'});
}

/* Highlights */
const passageCard=document.getElementById('passageCard');
const pPalette=document.getElementById('pPalette');
passageCard.addEventListener('mouseup',(e)=>{
  const sel=window.getSelection(); if(!sel||sel.toString().trim().length===0) return;
  if(!passageCard.contains(sel.getRangeAt(0).commonAncestorContainer)) return;
  const r=passageCard.getBoundingClientRect(), x=Math.min(e.clientX-r.left,r.width-10), y=Math.max(0,e.clientY-r.top-40);
  pPalette.style.left=(r.left+x)+'px'; pPalette.style.top=(r.top+y)+'px'; pPalette.style.display='block';
});
document.addEventListener('mousedown',(e)=>{ if(!pPalette.contains(e.target)) pPalette.style.display='none'; });
pPalette.querySelectorAll('.hbtn[data-color]').forEach(btn=>{
  btn.addEventListener('click',()=>{ markSelection(btn.dataset.color, passageCard); pPalette.style.display='none'; });
});
document.getElementById('clearPMarks').addEventListener('click',()=>{
  passageCard.querySelectorAll('span.highlight').forEach(n=>{ const p=n.parentNode; while(n.firstChild) p.insertBefore(n.firstChild,n); p.removeChild(n); p.normalize(); });
  pPalette.style.display='none';
});

/* Questions highlight */
const qCard=document.querySelector('.card.questions');
const qPalette=document.getElementById('qPalette');
qCard.addEventListener('mouseup',(e)=>{
  const sel=window.getSelection(); if(!sel||sel.toString().trim().length===0) return;
  if(!qCard.contains(sel.getRangeAt(0).commonAncestorContainer)) return;
  const node = sel.getRangeAt(0).commonAncestorContainer.nodeType===1 ? sel.getRangeAt(0).commonAncestorContainer : sel.getRangeAt(0).commonAncestorContainer.parentNode;
  if (node.closest && node.closest('input,textarea,select')) return;
  const r=qCard.getBoundingClientRect(), x=Math.min(e.clientX-r.left,r.width-10), y=Math.max(0,e.clientY-r.top-40);
  qPalette.style.left=(r.left+x)+'px'; qPalette.style.top=(r.top+y)+'px'; qPalette.style.display='block';
});
document.addEventListener('mousedown',(e)=>{ if(!qPalette.contains(e.target)) qPalette.style.display='none'; });
qPalette.querySelectorAll('.hbtn[data-color]').forEach(btn=>{
  btn.addEventListener('click',()=>{ markSelection(btn.dataset.color, qCard); qPalette.style.display='none'; });
});
document.getElementById('clearQMarks').addEventListener('click',()=>{
  qCard.querySelectorAll('span.highlight').forEach(n=>{ const p=n.parentNode; while(n.firstChild) p.insertBefore(n.firstChild,n); p.removeChild(n); p.normalize(); });
  qPalette.style.display='none';
});

/* Helper */
function markSelection(color, scope){
  const sel=window.getSelection(); if(!sel||!sel.rangeCount) return;
  const range=sel.getRangeAt(0);
  if(!scope.contains(range.commonAncestorContainer)) return;
  const container=range.commonAncestorContainer.nodeType===1? range.commonAncestorContainer : range.commonAncestorContainer.parentNode;
  if (container.closest && container.closest('input, textarea, select')) return;
  const frag=range.extractContents();
  const span=document.createElement('span'); span.className='highlight'; span.style.backgroundColor=color; span.appendChild(frag);
  range.insertNode(span); sel.removeAllRanges();
}

/* TG button */
document.querySelector('.tg').addEventListener('click',()=>window.open(CONFIG.telegramLink,'_blank'));
</script>
</body>
</html>