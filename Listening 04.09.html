<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS CDI Listening Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            line-height: 1.4;
            font-size: 16px;
            padding-bottom: 90px; /* nav-row height (80px) + some extra spacing */
        }

        .header {
            background-color: #ffffff;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 60px;
        }

        .ielts-logo {
            display: none;
        }

        .test-info {
            display: flex;
            align-items: center;
            gap: 30px;
            font-size: 14px;
            color: #333;
        }

        .audio-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .audio-icon {
            width: 16px;
            height: 16px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>') no-repeat center;
        }

        .header-icons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .telegram-link {
            color: #0088cc;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }

        .telegram-link::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: currentColor;
            -webkit-mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }

        #volume-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 4px;
            background: #ddd;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
        }

        #volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: none;
        }

        .icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon:hover {
            opacity: 1;
        }
        
        #play-pause-btn {
            background: none;
            border: none;
            padding: 0;
        }

        .main-container {
            margin-top: 60px;
            display: flex;
            background: #ffffff;
            padding-bottom: 100px; /* Space for bottom nav */
        }

        .main-container.results-mode {
            display: flex;
            flex-direction: row;
        }

        /* Left Panel */
        .left-panel {
            width: 100%;
            padding: 20px;
            transition: width 0.4s ease;
        }

        .main-container.results-mode .left-panel {
            width: 50%;
            overflow-y: auto;
            height: calc(100vh - 195px);
        }

        /* Right Panel */
        .right-panel {
            display: none;
            width: 50%;
            padding: 20px;
            position: relative;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            height: calc(100vh - 195px);
        }

        #transcription-container h2 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #transcription-text {
            white-space: pre-wrap;
            font-family: inherit;
            font-size: 15px;
            line-height: 1.7;
        }
        
        .transcription-instruction {
            display: block;
            margin: 1em 0;
            font-style: italic;
            color: #444;
        }

        .main-container.results-mode .right-panel {
            display: block;
            width: 50%;
            border-left: 1px solid #e0e0e0;
            border-top: none;
            height: calc(100vh - 195px);
            overflow-y: auto;
        }

        .help-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
        }

        .correct-answer-text {
            color: #28a745;
            font-weight: bold;
            margin-left: 10px;
        }

        .help-button:hover {
            background: #357abd;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .people-section {
            margin-bottom: 30px;
        }

        .people-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
        }

        .people-table th {
            text-align: left;
            padding: 10px;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .people-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }

        .person-name {
            font-size: 16px;
        }

        .question-number {
            background: white;
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
            color: #4a90e2;
            min-width: 30px;
            text-align: center;
        }

        .assigned-responsibility {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 14px;
            border: 1px solid #ddd;
        }

        .responsibilities-section {
            margin-bottom: 30px;
        }

        .responsibility-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .responsibility-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .responsibility-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .responsibility-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .questions-section {
            margin-bottom: 20px;
        }

        .question-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instruction {
            margin-bottom: 20px;
            font-size: 16px;
            color: #666;
        }

        .centered-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Map Styles */
        .map-container {
            position: relative;
            margin: 20px auto;
            width: 100%;
            max-width: 600px;
            display: block;
        }
        .map-container img {
            width: 100%;
            display: block;
        }
        .map-drop-zone {
            position: absolute;
            width: 13%;
            height: 15%;
            border: 2px dashed #999;
            background-color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #555;
            border-radius: 4px;
            padding: 2px;
        }
        .map-drop-zone:hover {
            background-color: rgba(230, 244, 255, 0.7);
            border-color: #4a90e2;
        }
        .map-drop-zone .drag-item {
            font-size: 14px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        .map-options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .map-options-list .drag-item {
            width: calc(25% - 10px);
            text-align: center;
        }

        /* Navigation Arrows */
        .nav-arrows {
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            gap: 5px;
            z-index: 101;
        }

        .nav-arrow {
            width: 50px;
            height: 50px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
        }

        .nav-arrow:hover {
            background: #555;
        }

        .nav-arrow:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Bottom Navigation - Exact Match */
        .nav-row {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
        
            padding: 0;
            display: flex;
            align-items: center;
            height: 80px;
            z-index: 100;

            /* Allow horizontal scrolling on smaller screens */
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .footer__questionWrapper___1tZ46 {
            display: flex;
            align-items: center;
            margin-right: 20px;
            flex-shrink: 0;
        }


        .footer__questionNo___3WNct {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }

        .footer__questionNo___3WNct:hover {
            background-color: #f8f9fa;
        }

        .section-prefix {
            font-size: 16px;
        }

        .sectionNr {
            font-size: 16px;
            font-weight: bold;
        }

        .attemptedCount {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
            font-weight: 400; /* Normal weight */
        }

        @media (max-width: 1024px) {
            .attemptedCount {
                display: none;
            }
        }

        .footer__questionWrapper___1tZ46.selected .attemptedCount {
            display: none;
        }

        .footer__subquestionWrapper___9GgoP {
            display: none;
            gap: 2px;
            margin-left: 10px;
        }

        .footer__questionWrapper___1tZ46.selected .footer__subquestionWrapper___9GgoP {
            display: flex;
        }

        .subQuestion {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .subQuestion.answered {
            background-color: #e9ecef;
            border-color: #ddd;
        }
        .subQuestion.correct {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .subQuestion.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .subQuestion:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .subQuestion.active {
            background-color: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        .subQuestion.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .footer__deliverButton___3FM07 {
            margin-left: auto;
            margin-right: 20px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s, border-color 0.2s;
            min-width: 170px;
            justify-content: center;
        }

        .footer__deliverButton___3FM07:hover {
            background-color: #e0e0e0;
            border-color: #bbb;
        }

        .footer__deliverButton___3FM07:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ddd;
        }

        .fa-check::before {
            content: "✓";
        }

        .hidden {
            display: none;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 140px;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f8f9fa;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background-color: #ffff00;
        }

        .comment-highlight {
            background-color: #90EE90;
            position: relative;
            cursor: help;
        }

        .comment-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .comment-highlight:hover .comment-tooltip {
            opacity: 1;
        }

        .question {
            margin-bottom: 40px;
        }
        .question p {
            margin-bottom: 10px;
        }
        .question ul, .question .people-table {
            margin-top: 0;
        }
        .question-prompt {
            margin-bottom: 20px;
        }
        .question ul {
            list-style: none;
            padding-left: 0;
        }
        .question ul li {
            margin-bottom: 5px;
        }
        .answer-input {
            border: 1px solid #888;
            border-radius: 4px;
            background-color: #fff;
            padding: 4px 8px;
            font-size: 16px;
            text-align: center;
            margin-right: 4px;
            margin-left: 4px;
            width: 140px;
            max-width: 160px;
            min-width: 120px;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            height: 24px;
            min-height: 24px;
            line-height: 1.2;
            vertical-align: middle;
        }
        .answer-input::placeholder {
            color: #999;
            font-weight: bold;
            text-align: center;
        }
        .answer-input.correct {
            border-color: #28a745;
            background-color: #e9f7ef;
        }
        .answer-input.incorrect {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }
                .answer-input {
            z-index: 10;
            position: relative;
            pointer-events: auto;
        }
        
        .answer-select {
            border: 1px solid #888;
            border-radius: 4px;
            background-color: #fff;
            padding: 4px 8px;
            font-size: 16px;
            margin-left: 0;
            min-width: 80px;
            cursor: pointer;
        }
        
        .answer-select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            align-items: flex-start;
        }
        .recommendations-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 200px;
        }
        .drag-item {
            background: white;
            border: 1px solid #9c9c9c;
            font-weight: 600;
            padding: 0px 5px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            transition: all 0.2s;
            user-select: none;
        }
        .drag-item:hover {
            background: #e9ecef;
        }
        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drop-zone {
            border: 1px dashed #ccc;
            border-radius: 4px;
            min-height: 40px;
            height: auto;
            max-width: 120px;
            min-width: 100px;
            transition: background-color 0.2s, border-color 0.2s;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            text-align: center;
            line-height: 1.2;
        }
        .drop-zone.drag-over {
            background-color: #e6f4ff;
            border-color: #4a90e2;
        }
        .drop-zone.correct {
            background-color: #e9f7ef;
            border-color: #28a745;
            border-style: solid;
        }
        .drop-zone.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            border-style: solid;
        }
        .drop-zone .drag-item {
            cursor: default;
        }
        .drag-item.selected {
            border-color: #4a90e2;
            box-shadow: 0 0 0 1px #4a90e2;
        }
        
        .summary-drop-zone {
            border: 2px dashed #9c9c9c;
            border-radius: 4px;
            width: 50%;
            margin-top: 19px;
            margin-bottom: 5px;
            transition: background-color 0.2s, border-color 0.2s;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            min-height: 35px;
            background: #fff;
        }
        
        .summary-drop-zone span {
            position: relative;
            z-index: 20;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #333;
        }
        
        .summary-drop-zone.drag-over {
            background-color: #e6f4ff;
            border-color: #4a90e2;
        }
        
        .summary-drop-zone.correct {
            background-color: #e9f7ef;
            border-color: #28a745;
            border-style: solid;
        }
        
        .summary-drop-zone.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            border-style: solid;
        }
        
        .summary-drop-zone .drag-item {
            display: inline;
            width: auto;
            height: auto;
            padding: 0;
            margin: 0;
            background: transparent;
            border: 0;
            border-radius: 0;
            font-size: 15px;
            font-weight: 500;
            cursor: default;
        }
        
        .drag-options-container {
            margin-top: 10px;
        }
        
        .drag-options-container .drag-item {
            display: block;
            width: fit-content;
            font-size: 15px;
            padding: 0.5px 10px;
            margin-bottom: 5px;
        }
        
        .drag-options-container .drag-item:last-child {
            margin-bottom: 0;
        }
        
        /* New layout for questions and drag zones on same line */
        .question-line {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 15px;
            gap: 5px;
        }
        
        .question-text {
            flex: 1;
            font-size: 16px;
        }
        
        .summary-drop-zone {
            flex-shrink: 0;
            width: fit-content;
            min-width: 200px;
            min-height: 35px;
            border: 2px dashed #9c9c9c;
            border-radius: 4px;
            transition: background-color 0.2s, border-color 0.2s;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            text-align: left;
            background: #fff;
        }

        .summary-drop-zone.filled {
            border-color: #4a90e2;
        }
        .questions-container {
            width: 50%;
        }
        
        /* Part 2 specific styling */
        #part-2 .questions-container {
            width: 60%;
        }
        
        /* All parts in results mode - make containers 100% width */
        .main-container.results-mode .questions-container {
            width: 100%;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
        }
        .part-header {
            background-color: #f1f2ec;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .part-header p {
            margin: 0;
        }

        .question li.correct {
            color: #155724;
            font-weight: bold;
        }
        .question li.incorrect {
            color: #721c24;
        }
        .question li.correct::before {
            content: '✔ ';
            color: #28a745;
        }
        .question li.incorrect::before {
            content: '✖ ';
            color: #dc3545;
        }

        .example-box {
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .timer-container {
            display: none; /* Timer hidden */
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
        .timer-container .timer-tooltip {
            display: none;
        }

        .audio-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(40, 40, 40, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .audio-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 500px;
            padding: 20px;
        }
        .audio-modal-content p {
            font-size: 16px;
            line-height: 1.5;
            color: #eee;
        }
        .audio-modal-icon {
            margin-bottom: 20px;
        }
        .modal-play-btn {
            background-color: #000;
            color: white;
            border: 1px solid white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .modal-play-btn:hover {
            background-color: #333;
        }
        #goto-widget {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #goto-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #goto-btn {
            padding: 4px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }

        @keyframes flash {
            0% { background-color: #e6f4ff; }
            100% { background-color: transparent; }
        }

        .question.flash {
            animation: flash 1s ease-out;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        #score-summary {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #result-details table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        #result-details th, #result-details td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        #result-details th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        #result-details td:nth-child(1) {
            font-weight: bold;
            text-align: center;
        }
        .result-correct {
            color: #28a745;
            font-weight: bold;
        }
        .result-incorrect {
            color: #dc3545;
            font-weight: bold;
        }
        
        #result-details table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #result-details th,
        #result-details td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        #result-details th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        #result-details tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .context-menu-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .matching-container {
            display: flex;
            justify-content: space-between;
            gap: 40px;
            margin-top: 20px;
            align-items: flex-start;
        }
        .matching-table {
            flex: 4;
            border-collapse: collapse;
        }
        .matching-table th, .matching-table td {
            border: 1px solid #ddd;
            padding: 6px 12px;
            text-align: left;
            vertical-align: middle;
        }
        .matching-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .matching-table .drop-zone {
            min-height: 35px;
            height: 35px;
            width: 100%;
            max-width: none;
            min-width: 200px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: nowrap;
            background-color: #fff;
            border: 1px dashed #ccc;
            border-radius: 4px;
            word-break: break-word;
            overflow-wrap: break-word;
            text-align: left;
            line-height: 1.2;
        }
        .matching-table .drop-zone .drag-item {
            width: auto;
            max-width: none;
            text-align: left;
            padding: 6px 8px;
            font-size: 14px;
            line-height: 1.2;
            word-break: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 2px;
        }
        .matching-options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            background-color: transparent;
            padding: 0;
            border: none;
            min-height: 250px;
            min-width: 280px; /* ensure enough width for long option text to stay on one line */
        }
        .matching-options-list .drag-item {
            width: 100%;
        }
        .matching-question-item .drop-zone .placeholder {
            color: #999;
            font-weight: bold;
        }

        .option strong,
        .question ul li label strong {
            display: none;
        }

        /* Mobile selection toolbar */
        .mobile-selection-menu {
            position: absolute;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            gap: 8px;
            z-index: 3000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
        .mobile-selection-menu button {
            background: transparent;
            border: 1px solid #fff;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .mobile-selection-menu.hidden {
            display: none;
        }

        /* === MCQ table styling for Questions 11-15 === */
        .mcq-table {
            width: 100%;
            border-collapse: collapse;
        }
        .mcq-table th,
        .mcq-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            vertical-align: middle;
            text-align: center;
        }
        .mcq-table th {
            background-color: #1e6de6; /* vibrant blue header like screenshot */
            color: #ffffff;
            font-weight: 600;
            text-align: center;
        }
        .mcq-table th:first-child {
            text-align: left;
        }
        .mcq-table tbody td:first-child {
            font-weight: 500;
            text-align: left;
        }
        .mcq-table tr:nth-child(even) td {
            background-color: #f8faff; /* subtle alternating row colour */
        }
        .mcq-table input[type="radio"] {
            transform: scale(1.1);
            cursor: pointer;
        }
        /* list of options (A, B, C) shown above the table */
        .mcq-options {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
        }
        .mcq-options li {
            margin-bottom: 4px;
            font-size: 16px;
        }

        /* Compact single-choice list */
        .single-choice-container { margin: 10px 0; display: flex; flex-direction: column; gap: 18px; }
        .single-choice label { display: block; margin-left: 20px; margin-top: 4px; font-size: 16px; }

        .aligned-form .question-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .aligned-form .question-label {
            width: 230px;
            padding-right: 10px;
        }

        /* Responsive adjustments for tablets */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel, .main-container.results-mode .right-panel {
                display: none;
            }
            .left-panel, .main-container.results-mode .left-panel {
                width: 100%;
                padding: 20px 10px;
                height: auto; /* Reset height for mobile */
            }
            .questions-container {
                width: 100%;
            }
        }

        .single-choice label.correct {
            color: #155724;
            font-weight: bold;
        }
        .single-choice label.correct::before {
            content: '✔ ';
            color: #28a745;
        }
        .single-choice label.incorrect {
            color: #721c24;
            text-decoration: line-through;
        }
        .single-choice label.incorrect::before {
            content: '✖ ';
            color: #dc3545;
        }
        .mcq-table tbody tr.correct {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }
        .mcq-table tbody tr.incorrect {
            background-color: #f8d7da !important;
            text-decoration: line-through;
        }
        .mcq-table tbody tr.incorrect td {
            color: #721c24;
        }

        /* New Audio Player Styles */
        .audio-player-container {
            position: fixed;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            max-width: 90%;
            height: 40px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 99;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .main-container {
            margin-top: 115px;
        }
        .player-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-btn svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }
        .progress-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #progress-bar {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #ddd;
            outline: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4a90e2;
            cursor: pointer;
        }
        #progress-bar::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4a90e2;
            cursor: pointer;
            border: none;
        }
        #current-time, #total-duration {
            font-size: 12px;
            color: #555;
            min-width: 35px;
            text-align: center;
        }
        .controls-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .volume-container {
            display: flex;
            align-items: center;
            position: relative;
        }
        #new-volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 60px;
            height: 3px;
            background: #ccc;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
            margin-left: 8px;
            display: block; 
        }
    
        #new-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
        }
        #new-volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            border: none;
        }
        .speed-container {
            position: relative;
        }
        #speed-btn {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
        }
        #speed-options {
            position: absolute;
            top: calc(100% + 5px); /* Position below the button with a small gap */
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }
        #speed-options div {
            padding: 8px 15px;
            cursor: pointer;
        }
        #speed-options div:hover {
            background-color: #f0f0f0;
        }

        /* Flowchart styles */
        .flowchart-container {
            border: 1px solid #ccc;
            padding: 0 20px;
        }
        .flowchart-step {
            text-align: center;
            margin: 0;
            padding: 20px 0;
            border-top: 1px solid #ddd;
        }
        .flowchart-step:first-child {
            border-top: none;
            padding-top: 20px;
            margin-top: 0;
        }
        .flowchart-arrow {
            text-align: center;
            margin: 0;
            padding: 15px 0;
            font-size: 20px;
            color: #555;
            border-top: 1px solid #ddd;
        }
        .flowchart-split {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
            border-top: 1px solid #ddd;
        }
        .flowchart-split-col {
            width: 48%;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .flowchart-split .flowchart-step {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }
        .flowchart-split .flowchart-arrow {
            border-top: none;
            padding: 15px 0;
        }


        /* Responsive adjustments for tablets */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel, .main-container.results-mode .right-panel {
                display: none;
            }
            .left-panel, .main-container.results-mode .left-panel {
                width: 100%;
                padding: 20px 10px;
                height: auto; /* Reset height for mobile */
            }
            .questions-container {
                width: 100%;
            }
            
            /* Adjust input boxes for tablets */
            .answer-input {
                width: 90px;
                max-width: 110px;
                font-size: 15px;
            }
            
            .drop-zone {
                max-width: 110px;
                min-width: 90px;
            }
            
            .matching-table .drop-zone {
                max-width: 110px;
                min-width: 90px;
            }
        }
        
        /* Responsive adjustments for mobile phones */
        @media (max-width: 768px) {
            .answer-input {
                width: 80px;
                max-width: 100px;
                font-size: 14px;
                padding: 2px 4px;
            }
            
            .drop-zone {
                max-width: 100px;
                min-width: 80px;
                font-size: 14px;
            }
            
            .matching-table .drop-zone {
                max-width: 100px;
                min-width: 80px;
            }
            
            .drag-item {
                font-size: 13px;
                padding: 4px 6px;
            }
            
            .matching-table .drop-zone .drag-item {
                font-size: 12px;
            }
            
            /* Ensure drag-drop containers are more mobile-friendly */
            .drag-drop-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .matching-container {
                flex-direction: column;
                gap: 20px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .answer-input {
                width: 70px;
                max-width: 90px;
                font-size: 13px;
            }
            
            .drop-zone {
                max-width: 90px;
                min-width: 70px;
            }
            
            .matching-table .drop-zone {
                max-width: 90px;
                min-width: 70px;
            }
        }
            /* Activity table styles */
        .abc-table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px;}
        .abc-table th{background-color:#007bff;color:white;padding:12px;text-align:center;font-weight:bold;border:1px solid #ddd;}
        .abc-table td{padding:12px;border:1px solid #ddd;vertical-align:top;}
        .abc-table .statement{text-align:left;width:60%;}
        .abc-table td:not(.statement){text-align:center;width:6.67%;min-width:60px;}
        .clickable-cell{cursor:pointer;transition:background-color 0.2s ease;min-height:40px;position:relative;}
        .clickable-cell:hover{background-color:#f0f8ff;border-color:#007bff;}
        .clickable-cell.selected{background-color:#e3f2fd;}
        .clickable-cell.correct{background-color:#d4edda !important;border-color:#c3e6cb;}
        .clickable-cell.incorrect{background-color:#f8d7da !important;border-color:#f5c6cb;}
    </style>
</head>
<body>
    <div class="header">
        <div class="timer-container">
            <span class="timer-display">60:00</span>
        </div>
        <a href="https://t.me/Avazbeks_Media" target="_blank" class="telegram-link">
            Avazbeks_Media
        </a>
        <div class="header-icons">
        
        </div>
    </div>

    <div class="audio-player-container">
        <button id="play-pause-btn" class="player-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <div class="progress-container">
            <span id="current-time">0:00</span>
            <input type="range" id="progress-bar" value="0" step="1" style="width: 100%;">
            <span id="total-duration">0:00</span>
        </div>
        <div class="controls-container">
            <div class="volume-container">
                <button id="volume-btn" class="player-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </button>
                <input type="range" id="new-volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
            <div class="speed-container">
                <button id="speed-btn" class="player-btn">1x</button>
                <div id="speed-options" class="hidden">
                    <div data-speed="0.5">0.5x</div>
                    <div data-speed="0.75">0.75x</div>
                    <div data-speed="1">1x</div>
                    <div data-speed="1.25">1.25x</div>
                    <div data-speed="1.5">1.5x</div>
                    <div data-speed="2">2x</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel">
            
            <div id="part-1" class="question-part">
                <div class="part-header">
                    <p><strong>Part 1</strong></p>
                    <p>Listen and answer questions 1–10.</p>
                </div>
                <div class="questions-container">
                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 1-10</strong></p>
                            <p>Complete the notes below.</p>
                    <p>Write <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> for each answer.</p>
                        </div>
                <div style="border: 1px solid #000000; padding: 15px;">
                    <p class="centered-title">Music Alive Agency</p>
                    <p style="font-style: italic; margin-bottom: 15px;">Example</p>
                    <p><strong>Contact person:</strong> Jim Granley</p>
                    <p>Members' details are on a <input type="text" id="q1" class="answer-input" placeholder="1"></p>
                    <p>Type of music represented: modern music (<input type="text" id="q2" class="answer-input" placeholder="2"> and jazz)</p>
                    <p>Newsletter comes out once a <input type="text" id="q3" class="answer-input" placeholder="3"></p>
                    <p>Cost of adult membership: £<input type="text" id="q4" class="answer-input" placeholder="4"></p>
                    <p>Current number of members: <input type="text" id="q5" class="answer-input" placeholder="5"></p>
                    <p>Facilities include: rehearsal rooms and a <input type="text" id="q6" class="answer-input" placeholder="6"></p>
                    <p>There is no charge for <input type="text" id="q7" class="answer-input" placeholder="7"> advice</p>
                    <p>To become a member, send</p>
                    <p>-a letter with contact details</p>
                    <p>-a recent <input type="text" id="q8" class="answer-input" placeholder="8"></p>
                    <p>Address: 707, <input type="text" id="q9" class="answer-input" placeholder="9"> Street, Marbury</p>
                    <p>Contact email: music.<input type="text" id="q10" class="answer-input" placeholder="10">@bsu.co.uk</p>
                </div>
                        
                    </div>
                </div>
            </div>

            <div id="part-2" class="question-part hidden">
                <div class="part-header">
                    <p><strong>Part 2</strong></p>
                    <p>Listen and answer questions 11–20.</p>
                </div>
                <div class="questions-container">
                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 11-14</strong></p>
                            <p>Choose the correct letter A, B or C.</p>
                            <p class="centered-title">Information for participants in the Albany fishing competition</p>
                        </div>
                        <div class="single-choice-container">
                            <div class="single-choice">
                                <p><strong>11</strong> What do participants need to take to the registration desk?</p>
                                <label><input type="radio" name="q11" value="A">&nbsp;&nbsp;a form of identification</label>
                                <label><input type="radio" name="q11" value="B">&nbsp;&nbsp;a competitor number</label>
                                <label><input type="radio" name="q11" value="C">&nbsp;&nbsp;cash for the entrance fee</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>12</strong> What does the entrance fee to the competition include?</p>
                                <label><input type="radio" name="q12" value="A">&nbsp;&nbsp;equipment for fishing</label>
                                <label><input type="radio" name="q12" value="B">&nbsp;&nbsp;all food for both days</label>
                                <label><input type="radio" name="q12" value="C">&nbsp;&nbsp;fuel for the fishing</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>13</strong> Participants without a fishing licence are recommended to apply for one</p>
                                <label><input type="radio" name="q13" value="A">&nbsp;&nbsp;at the registration desk.</label>
                                <label><input type="radio" name="q13" value="B">&nbsp;&nbsp;over the phone.</label>
                                <label><input type="radio" name="q13" value="C">&nbsp;&nbsp;on the internet.</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>14</strong> What will happen at 6pm on Sunday?</p>
                                <label><input type="radio" name="q14" value="A">&nbsp;&nbsp;The time allocated for fishing will end.</label>
                                <label><input type="radio" name="q14" value="B">&nbsp;&nbsp;The fish caught will be judged.</label>
                                <label><input type="radio" name="q14" value="C">&nbsp;&nbsp;The prizes will be awarded to the winners.</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 15-20</strong></p>
                            <p>Label the map below.</p>
                            <p>Write the correct letter, <strong>A-I</strong>, next to questions 15-20.</p>
                            <p class="centered-title">Albany Fishing Competition Map</p>
                            <div class="map-container">
                                <img src="https://ia600906.us.archive.org/32/items/skrinshot-2025-08-12-202707-copy-copy-copy-copy-copy-copy/Skrinshot%202025-08-12%20202707%20-%20CopyCopyCopyCopyCopyCopy.png" alt="Albany Fishing Competition Map" style="max-width: 100%; height: auto; border: 1px solid #ccc; margin: 20px 0;">
                            </div>
                        </div>
                        <div class="questions-container">
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>15</strong> Registration area</span>
                                    <select class="answer-select" id="q15">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>16</strong> Shore fishing area</span>
                                    <select class="answer-select" id="q16">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>17</strong> Boat launching area</span>
                                    <select class="answer-select" id="q17">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>18</strong> Judging area</span>
                                    <select class="answer-select" id="q18">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>19</strong> Dining area</span>
                                    <select class="answer-select" id="q19">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                            <div class="matching-question-item">
                                <div class="question-line">
                                    <span class="question-text"><strong>20</strong> Prize-giving area</span>
                                    <select class="answer-select" id="q20">
                                        <option value="">Select...</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                        <option value="E">E</option>
                                        <option value="F">F</option>
                                        <option value="G">G</option>
                                        <option value="H">H</option>
                                        <option value="I">I</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="part-3" class="question-part hidden">
                <div class="part-header">
                    <p><strong>Part 3</strong></p>
                    <p>Listen and answer questions 21–30.</p>
                </div>
                <div class="questions-container">
                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 21-26</strong></p>
                            <p>Choose the correct answer.</p>
                            <p class="centered-title">Preparing for the end-of-year art exhibition</p>
                        </div>
                        <div class="single-choice-container">
                            <div class="single-choice">
                                <p><strong>21</strong> Max and Abby agree that in the art exhibition they are looking forward to</p>
                                <label><input type="radio" name="q21" value="A">&nbsp;&nbsp;showing people their work.</label>
                                <label><input type="radio" name="q21" value="B">&nbsp;&nbsp;getting feedback from their tutor.</label>
                                <label><input type="radio" name="q21" value="C">&nbsp;&nbsp;talking to other students about their displays.</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>22</strong> In last year's exhibition, both students were impressed by</p>
                                <label><input type="radio" name="q22" value="A">&nbsp;&nbsp;a set of metal sculptures.</label>
                                <label><input type="radio" name="q22" value="B">&nbsp;&nbsp;a series of wooden models.</label>
                                <label><input type="radio" name="q22" value="C">&nbsp;&nbsp;a collection of textile designs.</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>23</strong> What has Max decided to call his display?</p>
                                <label><input type="radio" name="q23" value="A">&nbsp;&nbsp;Mother Nature</label>
                                <label><input type="radio" name="q23" value="B">&nbsp;&nbsp;Views of Farmland</label>
                                <label><input type="radio" name="q23" value="C">&nbsp;&nbsp;Seasons</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>24</strong> What does Abby think will be difficult about preparing for their displays?</p>
                                <label><input type="radio" name="q24" value="A">&nbsp;&nbsp;having enough time to set it up</label>
                                <label><input type="radio" name="q24" value="B">&nbsp;&nbsp;choosing which pieces to show</label>
                                <label><input type="radio" name="q24" value="C">&nbsp;&nbsp;filling up all the available space</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>25</strong> What does Abby say about the summary they have to write?</p>
                                <label><input type="radio" name="q25" value="A">&nbsp;&nbsp;She isn't sure whether people will read it.</label>
                                <label><input type="radio" name="q25" value="B">&nbsp;&nbsp;It will be difficult to keep it short enough.</label>
                                <label><input type="radio" name="q25" value="C">&nbsp;&nbsp;It will be hard to clarify the reasons for her work.</label>
                            </div>
                            <div class="single-choice">
                                <p><strong>26</strong> What aspect of the display will the students organise themselves?</p>
                                <label><input type="radio" name="q26" value="A">&nbsp;&nbsp;arranging the lighting</label>
                                <label><input type="radio" name="q26" value="B">&nbsp;&nbsp;inviting local journalists</label>
                                <label><input type="radio" name="q26" value="C">&nbsp;&nbsp;providing comment forms</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 27-30</strong></p>
                            <p>Which feature do the speakers identify as particularly interesting for each of the following exhibitions they saw?</p>
                            <p>Choose FOUR answers from the box and write the correct letter, <strong>A-F</strong>, next to questions 27-30.</p>
                        </div>
                        <div class="drag-drop-container">
                            <div class="questions-container">
                                <div class="matching-question-item">
                                    <div class="question-line">
                                        <span class="question-text"><strong>Exhibitions</strong></span>
                                    </div>
                                </div>
                                <div class="matching-question-item">
                                    <div class="question-line">
                                        <span class="question-text"> On the Water</span>
                                        <div class="summary-drop-zone" data-question="q27" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <span>27</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="matching-question-item">
                                    <div class="question-line">
                                        <span class="question-text"> City Life</span>
                                        <div class="summary-drop-zone" data-question="q28" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <span>28</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="matching-question-item">
                                    <div class="question-line">
                                        <span class="question-text"> Faces</span>
                                        <div class="summary-drop-zone" data-question="q29" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <span>29</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="matching-question-item">
                                    <div class="question-line">
                                        <span class="question-text"> Moods</span>
                                        <div class="summary-drop-zone" data-question="q30" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <span>30</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="drag-options-container" ondrop="dropBackToOptions(event)" ondragover="allowDrop(event)">
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="A">
                                    <strong>A</strong> the realistic colours
                                </div>
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="B">
                                    <strong>B</strong> the sense of space
                                </div>
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="C">
                                    <strong>C</strong> the unusual interpretation of the theme
                                </div>
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="D">
                                    <strong>D</strong> the painting technique
                                </div>
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="E">
                                    <strong>E</strong> the variety of materials used
                                </div>
                                <div class="drag-item" draggable="true" ondragstart="drag(event)" data-value="F">
                                    <strong>F</strong> the use of light and shade
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="part-4" class="question-part hidden">
                <div class="part-header">
                    <p><strong>Part 4</strong></p>
                    <p>Listen and answer questions 31–40.</p>
                </div>
                <div class="questions-container">
                    <div class="question">
                        <div class="question-prompt">
                            <p><strong>Questions 31-40</strong></p>
                            <p>Complete the notes below.</p>
                            <p>Write <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> for each answer.</p>
                        </div>
                        <div style="border: 1px solid #000000; padding: 15px; list-style-type: none;">
                            <p class="centered-title">The Mangrove Regeneration Project</p>
                            <p><strong>Background:</strong></p>
                            <p><strong>Mangrove forests:</strong></p>
                            <ul style="list-style-type: none; padding-left: 20px;">
                                <li>&bull;&nbsp;&nbsp; protect coastal areas from <input type="text" class="answer-input" id="q31" placeholder="31"> by the sea</li>
                                <li>&bull;&nbsp;&nbsp; are an important habitat for wildlife</li>
                            </ul>
                            <p><strong>Problems:</strong></p>
                            <ul style="list-style-type: none; padding-left: 20px;">
                                <li>&bull;&nbsp;&nbsp; mangroves had been used by farmers as <input type="text" class="answer-input" id="q32" placeholder="32"></li>
                                <li>&bull;&nbsp;&nbsp; mangroves were poisoned by the use of <input type="text" class="answer-input" id="q33" placeholder="33"></li>
                                <li>&bull;&nbsp;&nbsp; local people used the mangroves as a place to put their <input type="text" class="answer-input" id="q34" placeholder="34"></li>
                            </ul>
                            <p><strong>Actions taken to protect the mangroves:</strong></p>
                            <ul style="list-style-type: none; padding-left: 20px;">
                                <li>&bull;&nbsp;&nbsp; a barrier which was made of <input type="text" class="answer-input" id="q35" placeholder="35"> was constructed - but it failed</li>
                                <li>&bull;&nbsp;&nbsp; new mangroves had to be grown from seed</li>
                                <li>&bull;&nbsp;&nbsp; the seeds of the <input type="text" class="answer-input" id="q36" placeholder="36"> mangrove were used</li>
                            </ul>
                            <p><strong>First set of seedlings:</strong></p>
                            <ul style="list-style-type: none; padding-left: 20px;">
                                <li>&bull;&nbsp;&nbsp; kept in small pots in a <input type="text" class="answer-input" id="q37" placeholder="37"></li>
                                <li>&bull;&nbsp;&nbsp; Watered with <input type="text" class="answer-input" id="q38" placeholder="38"> rain water</li>
                                <li>&bull;&nbsp;&nbsp; planted out on south side of a small island</li>
                                <li>&bull;&nbsp;&nbsp; at risk from the large <input type="text" class="answer-input" id="q39" placeholder="39"> population</li>
                            </ul>
                            <p><strong>Second set of seedlings:</strong></p>
                            <ul style="list-style-type: none; padding-left: 20px;">
                                <li>&bull;&nbsp;&nbsp; planted in the seabed near established mangrove roots</li>
                                <li>&bull;&nbsp;&nbsp; the young plants were destroyed in a <input type="text" class="answer-input" id="q40" placeholder="40"></li>
                            </ul>
                            <p><strong>Results:</strong> The first set of seedlings was successful</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div id="transcription-container">
                <h2>Transcription</h2>
                <pre id="transcription-text"></pre>
            </div>
        </div>
    </div>

    <div id="transcription-data" style="display:none;">
        <div data-part="1"><strong>SECTION 1</strong>

IELTS Listening, Version 30579. You will hear a number of different recordings, and you will have to answer questions on what you hear. There will be time for you to read the instructions and questions, and you will have a chance to check your work.

All the recordings will be played once only. The test is in four sections. Write all your answers in the listening question booklet.

At the end of the test, you will be given ten minutes to transfer your answers to an answer sheet. Now turn to section 1 on page 2 of your question booklet. Section 1. You will hear a telephone conversation between a musician and a man working in a music agency.

First, you have some time to look at questions 1 to 5 on page 2. You will see that there is an example that has been done for you. On this occasion only, the conversation relating to this will be played first. Hello, Music Alive.

How can I help you? Hi. I've just moved to the area and I saw your advert. I wanted to find out about your services.

Sure. What would you like to know? Well, I've got a number of questions, if that's OK. Have you got a few minutes? Of course.

Can I make a note of your name? Yes, I'm Jim. Jim Granley. The man's name is Jim Granley, so Granley has been written in the space.

Now we shall begin. You should answer the questions as you listen because you will not hear the recording a second time. Listen carefully and answer questions 1 to 5. Hello, Music Alive.

How can I help you? Hi. I've just moved to the area and I saw your advert. I wanted to find out about your services.

Sure. What would you like to know? Well, I've got a number of questions, if that's OK. Have you got a few minutes? Of course.

Can I make a note of your name? Yes, I'm Jim. Jim Granley. Thanks.

And do you represent every type of musician? Can you tell me a bit about that? Well, we're basically a networking agency for musicians, but we don't actually find you work. We have all our members on our database, the type of music they play, and also we can put people in touch if they want to form a band, for example. Is there a lot of live music here? Yes, and venues contact us when they need musicians, etc.

We deal with modern music, especially rock, which is what most people seem to enjoy around here. But we do also represent some jazz musicians. We don't accept classical music, I'm afraid.

No, that's fine. What do you play? Guitar and violin, and a bit of flute. As I'm new here, I thought you could help me get in touch with people.

I see. Sure. We actually have a newsletter I could send you that would give you a good idea of what we do, and how you can benefit from joining.

The latest one came out this week. Would you like me to send you a copy? That would be great. Is it weekly? No, every month.

Weekly would be too much work, I think. Right. And what are the costs for joining and becoming a member? Is it expensive? I'm on a tight budget.

You and every other musician in the region. No, we do everything to keep costs down, because we know what it's like. We're pretty much all musicians ourselves, too.

So to join is just £35, and that's a one-off payment. Oh, actually, that's the discounted rate for young musicians under 18s. The standard rate is £45.

Unfortunately, I'm over 18. And how about joining? Can I join when I want? Now, for example? Or do you have a limit on numbers? No, you can join any time. We don't have a limit on the numbers of members we can have.

The more, the merrier, in fact. Our membership's gone up recently, from 700 to 750. Before you hear the rest of the conversation, you have some time to look at questions 6-10 on page 2. Now listen and answer questions 6-10.

That's good. And your ad says you also have facilities there that musicians can use. Can you explain a bit about that? Sure.

Well, it's not huge, but we do have a couple of rooms where you can rehearse. They're soundproof. And we've just opened a studio, a small one.

And it's already proving popular with bands that want to send demo tapes to venues and record labels. Wow, that sounds brilliant. And is that free? Guess not.

No, that's extra. But we do have some free services. For example, we can offer legal advice if you need it, for contracts and things like that.

Pretty useful stuff, you know. Great. So, if I'm interested, what's the next step? How do I become a member? Well, simple really.

Just send us a letter with your contact details and a recording made within the last couple of months. That'll give other members an idea of what you play. And where are you based? We're at 707 Kippax Street, Marbury.

How do you spell Kippax? It's K-I-double-P-A-X. And is there an email address? Yes, it's music.talent at bsu.co.uk. Talent as in the word? Yes. Right.

Just one last thing.</div>

        <div data-part="2"><strong>SECTION 2</strong>

Section 2. You'll hear the organizer of a fishing competition giving a talk to people participating in the event. First, you have some time to look at questions 11 to 14 on page 3. Now listen carefully and answer questions 11 to 14.

Hello everyone and welcome to the Albany Fishing Competition. I'm going to give you some information you'll need for the next two days. Right, let's talk about registration.

You'll need to head to the registration desk before the event starts. If you're here to compete rather than just watch, you'll have already paid your entrance fee online and you will have been given a competitor number. But to fully complete your registration in the competition, we'll need to see some form of identification today.

So make sure you show that at the desk, otherwise you won't be properly entered. Right, so what do you get for your entrance fee? This is a fully catered competition. So whenever you're hungry, either today or tomorrow, just go down to the dining tent.

As for things necessary for fishing, you know, your hooks, rods, all your gear, I'm sure you've brought all that with you. And if you fancy fishing from a boat, you'll need to cover the cost of petrol. OK, now, if you want to fish in this country, you must have a fishing licence and have it with you.

If you don't have one, don't worry. You can always go online and they'll issue you one immediately. We wanted to be able to sell them here at the competition, but the council wouldn't allow it, sadly.

I think it's also possible to call the Department of Fisheries, but they send them by post, so obviously you won't get that in time now. OK, so the competition starts today and ends on Sunday evening. At 5.30pm you will all have to stop fishing and at 6pm exactly the judges will start weighing the fish to see how heavy they are in order to choose the winners.

So you'll need to be in the judging area before then. The prize giving will happen later in the evening. Before you hear the rest of the talk, you have some time to look at questions 15 to 20 on page 4. Now listen and answer questions 15 to 20.

Right, have a look at your maps and I'll point out the important places. First, the registration area. To get to it, go to the roundabout in the middle of your map.

From there, take the road that heads to the east. You'll find the registration desk on that road. It's a nice shady area surrounded by trees.

OK, if you're planning to fish from the shore tomorrow, then there's a specially designated area for you. The shore fishing area is in one particular spot. You can't just go anywhere on the coastline.

You'll find the area directly to the north of the skate park. If you're planning to fish from a boat, you'll need to go to the boat launching area. To reach it, you should go to the roundabout and take the road that's on the right.

Follow that road to the beach and that's where you launch your boat. When the competition is over, you need to take your catch to the judging area so we can determine who the winner is. To get there, head out from the carpark and take the first road on your left.

Go past the first aid tent and the judging area will be set up down there. Meals will be served in the dining area. To get there, you'll need to go to the roundabout and take the road that leads west.

Follow that road and just where there's a sharp bend, you'll find where you can eat. If you keep going, you'll come to a lighthouse. If you're lucky enough to win, or you just want to see the winners get their prizes, you'll need to head to the prize-giving area.

It's north of the roundabout past the playground. The prize-giving area is at the end of that road right on the beach. Okay, that's going to be a really... That is the end of Section 2. You now have half a minute to check your answers.</div>

        <div data-part="3"><strong>SECTION 3</strong>

Section 3 You will hear two first-year art students called Max and Abby talking about their end-of-year art exhibition. First, you have some time to look at questions 21 to 26 on page 5. Now listen carefully and answer questions 21 to 26. So, Abby, we have to prepare our individual displays for the end-of-year exhibition to showcase all the work we've done for the first year of our art degree.

Yeah, Max, I've been thinking about how to put it all together. I'm excited about letting my friends and family see all the stuff I've produced. Me too.

Actually, I'm really keen to see the work of the other students on our course. I mean, it'll be great to see all the finished displays. But we've seen what they've been doing throughout the year already, really.

Anyway, what about getting feedback on our exhibition from our tutor? I wonder what that'll be like. Mmm, I'm a bit nervous about that part. Mmm.

I hope our stuff ends up looking as good as some of the displays in last year's exhibition. Yeah. Do you remember that display of printed textiles? Fantastic mixtures of silk and wool, all coloured with natural dyes.

Yeah, I can't actually remember that. What sticks in my mind are those ten wooden reproductions one student made, all of different types of transport, little cars and trains and stuff. Yes.

It was really delicate work and much harder to do than if he'd tried to construct them out of metal. So, our tutor asked us to come up with a name for our display, which reflects the work we've done. What have you gone for? Well, most of what I've done has focused on the countryside, so I've been thinking of things connected to that.

A lot of my larger pieces are views of farmland. That's not a particularly memorable name, though. I've gone for Mother Nature in the end, though I did think about the name Seasons as the fields are shown at different times over the farming year.

Oh, OK. Do you think it's going to be challenging putting our displays together? Well, I've pretty much come to a conclusion about which pieces I'll include now. I'll have to miss out some of my preparatory drawings for the bigger pieces to make sure my best work fits into the space we've been allocated.

I'm more concerned about how long it will take me to put everything in place. We've got a day and a half. That'll be plenty.

We'll see. What about writing the summary of our work? It's for people who visit the exhibition to read and I'm absolutely certain they will. It explains the reasons behind our work and they'll want to know what it all means.

We've got a strict word limit to stick to, but I've got so much to say it won't be easy to say it in so few words. Hmm. So, what about other organisational stuff? We'll need good lighting for one thing.

The technical guys are doing that, aren't they? Yeah. One thing to do is copy a load of comment forms so people can write what they think of the exhibition. Hopefully they'll be kind.

I'm sure they will. I don't know about the journalists who've been invited though. They might not be quite as nice to us.

Well, fingers crossed. You never know. Before you hear the rest of the discussion, you have some time to look at questions 27 to 30 on page 6. Now listen and answer questions 27 to 30.

So, our tutor suggested visiting a few exhibitions to look at the way work is presented and to give us a few ideas about improving and displaying our own work. Yeah, I liked the On the Water exhibition, the way the artist used the brush strokes in the oil painting to create a sense of movement was amazing. Hmm.

It takes a long time to develop skill like that. Maybe we'll get there one day. What I liked about the City Life exhibition was the fact that although the paintings themselves were of busy places, the display itself wasn't crowded at all.

Perhaps the fact that the paintings were actually quite small was what created a more open feeling to the exhibition. Yeah, though the way they were arranged wasn't especially unusual. And then there was the Faces exhibition.

Yeah, I mean, painting people's portraits isn't a new thing. But what I did like was the way the artist managed to reproduce the exact tones of the skin and hair of the people in the pictures. And the last exhibition we went to see was Moods.

Hmm. I expected that to show emotions. People laughing, crying, whatever.

But it was about plants. You don't tend to think of trees and flowers having feelings. And I'm not sure they do.

But it certainly seemed that way in the pictures. Not the most obvious choice of subject, that's for sure. Anyway, I guess we'd better get on with it.

That is the end of Section 3. You now have half a minute to check your answers.</div>

        <div data-part="4"><strong>SECTION 4</strong>

Now turn to Section 4 on page 7. Section 4 You will hear part of a student presentation about a conservation project on the Florida coast of the United States. First you have some time to look at questions 31 to 40 on page 7. Now listen carefully and answer questions 31 to 40.

Today I'm going to be talking about the first year of a regeneration project in a mangrove forest. Mangrove forests are found along river estuaries and coastlines and are important because they prevent flooding by acting as a barrier between the land and sea. The mangrove trees have special roots, which can breathe and allow them to survive in thick, airless mud.

They are also a very important habitat for wading birds, fish, and other animals. In the area where the project is taking place, there have been a number of problems since the area was first settled over 100 years ago. Many of the mangrove trees were initially burnt as firewood by local farmers.

The mangrove forests were also poisoned by settlers' farming methods because the farmers used fertilizer to increase crop yields and this started to seep into the water, eventually killing part of the mangrove forest. Farming in the area wasn't successful and what was left of the mangrove forest area wasn't valued by local people as crops couldn't be grown there. And so what happened was that the area started to be used as somewhere to dump trash.

Action was urgently needed to protect the mangrove forest and prevent flooding, and so the Mangrove Regeneration Project was set up. The conservationists involved decided to construct a sand barrier around the forests, but unfortunately this proved to be ineffective. The only way forward appeared to be to grow new mangroves from seed.

Several species of mangrove inhabit the forests in this area of the United States, but it is the gray mangroves that we are concerned with here. The seed of this plant is about the size of an almond and most seeds fall only when they are fully ripe. The Mangrove Regeneration Project first began three years ago.

The first set of seedlings was planted in small pots and left to germinate in a hothouse. The plants thrived and large roots appeared at the bottom of the pots. Ideally, these seedlings should have been conditioned with increasingly salty water before being planted in the sea.

They had, in fact, only been watered with rainwater. As the plants weren't used to a saline environment, it was decided to plant them out on the south side of a small island nearby. It was hoped that this would allow them to get used to salt water gradually since this part of the island was flooded every day at high tide.

There were over 100 plants planted in this particular spot and it was necessary to protect them not from the large number of wading birds which visit the area looking for food, but from the large rabbit colony living in the area. The process for the second set of seedlings was completely different. Young seedlings were collected from the forests and then taken to a new site.

The seedlings were then planted in the seabed behind old mangrove roots for protection. However, this method did not prove very successful and the vast majority of these seedlings were washed away in a storm. Luckily, the first set of seedlings survived and this method is the one which the project will continue to use in the future.

Now, I'd like to describe in more detail... That is the end of section 4. You now have half a minute to check your answers. That is the end of the listening test. You now have 10 minutes to transfer your answers to the listening answer sheet.</div>
    </div>

    <audio id="global-audio-player" class="hidden"></audio>

    <!-- Navigation Arrows -->
    <div class="nav-arrows">
        <button class="nav-arrow" onclick="previousPart()" id="prevBtn">‹</button>
        <button class="nav-arrow" onclick="nextPart()" id="nextBtn">›</button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="nav-row perScorableItem" aria-label="Questions">
        <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(1)">
                <span>
                    <span aria-hidden="true" class="section-prefix">Part </span>
                    <span class="sectionNr" aria-hidden="true">1</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(1)"><span class="sr-only">Question 1</span><span aria-hidden="true">1</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(2)"><span class="sr-only">Question 2</span><span aria-hidden="true">2</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(3)"><span class="sr-only">Question 3</span><span aria-hidden="true">3</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(4)"><span class="sr-only">Question 4</span><span aria-hidden="true">4</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(5)"><span class="sr-only">Question 5</span><span aria-hidden="true">5</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(6)"><span class="sr-only">Question 6</span><span aria-hidden="true">6</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(7)"><span class="sr-only">Question 7</span><span aria-hidden="true">7</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(8)"><span class="sr-only">Question 8</span><span aria-hidden="true">8</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(9)"><span class="sr-only">Question 9</span><span aria-hidden="true">9</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(10)"><span class="sr-only">Question 10</span><span aria-hidden="true">10</span></button>
            </div>
        </div>
        
        <div class="footer__questionWrapper___1tZ46 selected multiple" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(2)">
                <span>
                    <span aria-hidden="true" class="section-prefix">Part </span>
                    <span class="sectionNr" aria-hidden="true">2</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(11)"><span class="sr-only">Question 11</span><span aria-hidden="true">11</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(12)">
                    <span class="sr-only">Question 12</span>
                    <span aria-hidden="true">12</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(13)">
                    <span class="sr-only">Question 13</span>
                    <span aria-hidden="true">13</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(14)">
                    <span class="sr-only">Question 14</span>
                    <span aria-hidden="true">14</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(15)">
                    <span class="sr-only">Question 15</span>
                    <span aria-hidden="true">15</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(16)">
                    <span class="sr-only">Question 16</span>
                    <span aria-hidden="true">16</span>
                </button>
                <button class="subQuestion active scorable-item" onclick="goToQuestion(17)">
                    <span class="sr-only">Question 17</span>
                    <span aria-hidden="true">17</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(18)">
                    <span class="sr-only">Question 18</span>
                    <span aria-hidden="true">18</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(19)">
                    <span class="sr-only">Question 19</span>
                    <span aria-hidden="true">19</span>
                </button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(20)">
                    <span class="sr-only">Question 20</span>
                    <span aria-hidden="true">20</span>
                </button>
            </div>
        </div>
        
        <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(3)">
                <span>
                    <span aria-hidden="true" class="section-prefix">Part </span>
                    <span class="sectionNr" aria-hidden="true">3</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(21)"><span class="sr-only">Question 21</span><span aria-hidden="true">21</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(22)"><span class="sr-only">Question 22</span><span aria-hidden="true">22</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(23)"><span class="sr-only">Question 23</span><span aria-hidden="true">23</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(24)"><span class="sr-only">Question 24</span><span aria-hidden="true">24</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(25)"><span class="sr-only">Question 25</span><span aria-hidden="true">25</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(26)"><span class="sr-only">Question 26</span><span aria-hidden="true">26</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(27)"><span class="sr-only">Question 27</span><span aria-hidden="true">27</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(28)"><span class="sr-only">Question 28</span><span aria-hidden="true">28</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(29)"><span class="sr-only">Question 29</span><span aria-hidden="true">29</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(30)"><span class="sr-only">Question 30</span><span aria-hidden="true">30</span></button>
            </div>
        </div>
        
        <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(4)">
                <span>
                    <span aria-hidden="true" class="section-prefix">Part </span>
                    <span class="sectionNr" aria-hidden="true">4</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(31)"><span class="sr-only">Question 31</span><span aria-hidden="true">31</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(32)"><span class="sr-only">Question 32</span><span aria-hidden="true">32</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(33)"><span class="sr-only">Question 33</span><span aria-hidden="true">33</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(34)"><span class="sr-only">Question 34</span><span aria-hidden="true">34</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(35)"><span class="sr-only">Question 35</span><span aria-hidden="true">35</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(36)"><span class="sr-only">Question 36</span><span aria-hidden="true">36</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(37)"><span class="sr-only">Question 37</span><span aria-hidden="true">37</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(38)"><span class="sr-only">Question 38</span><span aria-hidden="true">38</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(39)"><span class="sr-only">Question 39</span><span aria-hidden="true">39</span></button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(40)"><span class="sr-only">Question 40</span><span aria-hidden="true">40</span></button>
            </div>
        </div>
        
        <button id="deliver-button" aria-label="Review your answers" class="footer__deliverButton___3FM07">
            <i class="fa fa fa-check" aria-hidden="true"></i>
            <span>Check Answers</span>
        </button>
    </nav>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="highlight-item" onclick="highlightText()">
            <span class="context-menu-icon">
                <svg viewBox="0 0 24 24" fill="black"><path d="M15.24 12.32L12.28 9.36l-1.04 1.04-1.04-1.04-1.04 1.04-1.04-1.04-1.04 1.04-1.04-1.04-3.12 3.12c-.59.58-1.54.58-2.12 0l-1.04-1.04c-.58-.59-.58-1.54 0-2.12L7.88.88c.59-.58 1.54-.58 2.12 0l1.04 1.04 1.04-1.04 1.04 1.04 1.04-1.04 1.04 1.04 1.04-1.04 3.12 3.12c.58.59.58 1.54 0 2.12l-1.04 1.04c-.58.59-1.54.59-2.12 0zM12 15l-3 3-7-7 3-3 7 7zm-9-5l-2.29 2.29c-.39.39-.39 1.02 0 1.41l8.29 8.29c.39.39 1.02.39 1.41 0L22.7 8.41c.39-.39.39-1.02 0-1.41L14.42.29c-.39-.39-1.02-.39-1.41 0L3 10z"/></svg>
            </span>
            <span>Highlight</span>
        </div>
        <div class="context-menu-item" id="comment-item" onclick="addComment()">
            <span class="context-menu-icon">
                <svg viewBox="0 0 24 24" fill="black"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 12H5.17L4 15.17V4h16v10z"/></svg>
            </span>
            <span>Comment</span>
        </div>
        <div class="context-menu-item" id="clear-item" onclick="clearHighlight()" style="display:none;">
            <span class="context-menu-icon">
                <svg viewBox="0 0 24 24" fill="black"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </span>
            <span>Clear</span>
        </div>
        <div class="context-menu-item" onclick="clearAllHighlights()">
            <span class="context-menu-icon">
                <svg viewBox="0 0 24 24" fill="black"><path d="M16 9h-2.29l3-3-1.42-1.42-3 3V5h-2v2.29l-3-3-1.42 1.42 3 3H5v2h2.29l-3 3 1.42 1.42 3-3V17h2v-2.29l3 3 1.42-1.42-3-3H17V9h-2zm-4 4h-2v-2h2v2z"/></svg>
            </span>
            <span>Clear All</span>
        </div>
    </div>

    <!-- Mobile highlight/comment toolbar -->
    <div id="mobile-selection-menu" class="mobile-selection-menu hidden">
        <button onclick="highlightText()">Highlight</button>
        <button onclick="addComment()">Comment</button>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Your Results</h2>
                <button id="modal-close-button" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="score-summary"></p>
                <div id="result-details"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPart = 1;
        let currentQuestion = 1;
        let selectedText = '';
        let selectedRange = null;
        let draggedElement = null;
        let testStarted = false;
        let timeInSeconds = 3600;
        let isHovering = false;
        let timerInterval;
        let contextElement = null;

        function updateAnsweredIndicators() {
            for (let qNum = 1; qNum <= 40; qNum++) {
                const btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${qNum})"]`);
                if (!btn) continue;

                // Do not change style if it's already marked correct or incorrect
                if (btn.classList.contains('correct') || btn.classList.contains('incorrect')) {
                    continue;
                }

                let isAnswered = false;
                const textInput = document.getElementById(`q${qNum}`);
                const radioInput = document.querySelector(`input[name="q${qNum}"]:checked`);
                const selectInput = document.getElementById(`q${qNum}`);
                const dropZone = document.querySelector(`.drop-zone[data-question-id="${qNum}"]`);
                const summaryDropZone = document.querySelector(`.summary-drop-zone[data-question="q${qNum}"]`);

                if (textInput && textInput.value.trim() !== '') {
                    isAnswered = true;
                } else if (radioInput) {
                    isAnswered = true;
                } else if (selectInput && selectInput.tagName === 'SELECT' && selectInput.value !== '' && selectInput.value !== 'Select') {
                    isAnswered = true;
                } else if ((dropZone && dropZone.querySelector('.drag-item')) || (summaryDropZone && summaryDropZone.querySelector('.drag-item'))) {
                    isAnswered = true;
                } else if ((qNum >= 15 && qNum <= 20) && document.querySelector(`.clickable-cell[data-question="q${qNum}"][data-selected="true"]`)) {
                    isAnswered = true;
                } else if ((qNum >= 25 && qNum <= 30) && document.querySelector(`.clickable-cell[data-question="q${qNum}"][data-selected="true"]`)) {
                    isAnswered = true;
                } else if ((qNum >= 25 && qNum <= 30)) {
                    // Check for checkbox answers (questions 25-30)
                    const aliasMap = { 26: 'q25', 28: 'q27', 30: 'q29' };
                    const nameToRead = aliasMap[qNum] || `q${qNum}`;
                    const checkedBoxes = document.querySelectorAll(`input[name="${nameToRead}"]:checked`);
                    isAnswered = checkedBoxes.length > 0;
                    console.log(`🔍 Q${qNum} (via ${nameToRead}): ${checkedBoxes.length} checked → ${isAnswered ? 'Answered' : 'Not answered'}`);
                } else if (qNum === 13) {
                    const checkedBoxes = document.querySelectorAll('input[name="q13-14"]:checked');
                    isAnswered = checkedBoxes.length > 0;
                } else if (qNum === 14) {
                    const checkedBoxes = document.querySelectorAll('input[name="q13-14"]:checked');
                    isAnswered = checkedBoxes.length > 1;
                } else if ((qNum >= 17 && qNum <= 18) && document.querySelector('input[name="q17-18"]:checked')) {
                    isAnswered = true;
                } else if ((qNum >= 19 && qNum <= 20) && document.querySelector('input[name="q19-20"]:checked')) {
                    isAnswered = true;
                } else if ((qNum >= 21 && qNum <= 23) && document.querySelector('input[name="q21-23"]:checked')) {
                    isAnswered = true;
                }

                if (isAnswered) {
                    btn.classList.add('answered');
                    console.log(`Question ${qNum} marked as answered`);
                } else {
                    btn.classList.remove('answered');
                    console.log(`Question ${qNum} marked as not answered`);
                }
            }
        }

        const audioPlayer = document.getElementById('global-audio-player');
        const timerContainer = document.querySelector('.timer-container');
        const timerDisplay = document.querySelector('.timer-display');
        const volumeSlider = document.getElementById('new-volume-slider');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalDurationEl = document.getElementById('total-duration');
        const speedBtn = document.getElementById('speed-btn');
        const speedOptions = document.getElementById('speed-options');
        const volumeBtn = document.getElementById('volume-btn');

        const audioSource = 'https://ia802909.us.archive.org/25/items/section-1-z-7j-ed-xi-b-copy-copy-copy-copy-copy-copy-copy-copy-copy/section-1_z7jEdXiB%20-%20CopyCopyCopyCopyCopyCopyCopyCopyCopy.m4a';
        audioPlayer.src = audioSource;

        const correctAnswers = {
            // Part 1 - Music Alive Agency
            'q1': ['database'],
            'q2': ['rock'],
            'q3': ['month'],
            'q4': ['45'],
            'q5': ['750'],
            'q6': ['studio'],
            'q7': ['legal'],
            'q8': ['recording'],
            'q9': ['kippax'],
            'q10': ['talent'],
            // Part 2 - Albany Fishing Competition
            'q11': 'A',
            'q12': 'B',
            'q13': 'C',
            'q14': 'B',
            'q15': 'G',
            'q16': 'A',
            'q17': 'C',
            'q18': 'H',
            'q19': 'D',
            'q20': 'B',
            // Part 3 - Art Exhibition
            'q21': 'A',
            'q22': 'B',
            'q23': 'A',
            'q24': 'A',
            'q25': 'B',
            'q26': 'C',
            'q27': 'D',
            'q28': 'B',
            'q29': 'C',
            'q30': 'A',
            // Part 4 - Mangrove Regeneration Project
            'q31': ['flooding'],
            'q32': ['firewood', 'Firewood'],
            'q33': ['fertilizer', 'Fertilizer'],
            'q34': ['trash'],
            'q35': ['sand'],
            'q36': ['grey'],
            'q37': ['hot house', 'hothouse'],
            'q38': ['salty'],
            'q39': ['rabbit'],
            'q40': ['storm']
        };
        
        const questionTypes = {
            'q1': 'text', 'q2': 'text', 'q3': 'text', 'q4': 'text', 'q5': 'text',
            'q6': 'text', 'q7': 'text', 'q8': 'text', 'q9': 'text', 'q10': 'text',
            'q11': 'mcq', 'q12': 'mcq', 'q13': 'mcq', 'q14': 'mcq', 'q15': 'select',
            'q16': 'select', 'q17': 'select', 'q18': 'select', 'q19': 'select', 'q20': 'select',
            'q21': 'mcq', 'q22': 'mcq', 'q23': 'mcq', 'q24': 'mcq', 'q25': 'mcq',
            'q26': 'mcq', 'q27': 'drag_drop', 'q28': 'drag_drop', 'q29': 'drag_drop', 'q30': 'drag_drop',
            'q31': 'text', 'q32': 'text', 'q33': 'text', 'q34': 'text', 'q35': 'text',
            'q36': 'text', 'q37': 'text', 'q38': 'text', 'q39': 'text', 'q40': 'text'
        };


        function setupCheckboxLimits() {
            const checkboxGroups = [
                { name: 'q18-20', limit: 3 },
            ];

            checkboxGroups.forEach(group => {
                const checkboxes = document.querySelectorAll(`input[name="${group.name}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('click', () => {
                        const checkedCount = document.querySelectorAll(`input[name="${group.name}"]:checked`).length;
                        if (checkedCount > group.limit) {
                            checkbox.checked = false;
                        }
                    });
                });
            });
        }

        function switchToPart(partNumber, andPlay = false) {
            if (currentPart !== partNumber) {
                const firstQuestionOfPart = (partNumber - 1) * 10 + 1;
                currentQuestion = firstQuestionOfPart;
            }
            
            currentPart = partNumber;

            updateNavigation();
            document.querySelectorAll('.question-part').forEach(part => part.classList.add('hidden'));
            const partToShow = document.getElementById(`part-${partNumber}`);
            if (partToShow) {
                partToShow.classList.remove('hidden');
            }

            const transcriptionSource = document.querySelector(`#transcription-data [data-part="${partNumber}"]`);
            const transcriptionTarget = document.getElementById('transcription-text');
            if (transcriptionSource && transcriptionTarget) {
                transcriptionTarget.innerHTML = transcriptionSource.innerHTML;
            }

            updateNavigation();
        }

        function updateNavigation() {
            document.querySelectorAll('.footer__questionWrapper___1tZ46').forEach((wrapper, index) => {
                wrapper.classList.remove('selected');
                updateAttemptedCount(index + 1);
            });
            const currentWrapper = document.querySelectorAll('.footer__questionWrapper___1tZ46')[currentPart - 1];
            if (currentWrapper) {
                currentWrapper.classList.add('selected');
            }
            document.getElementById('prevBtn').disabled = currentQuestion === 1;
            document.getElementById('nextBtn').disabled = currentQuestion === 40;
        }

        function goToQuestion(questionNumber) {
            currentQuestion = questionNumber;
            let partNumber = 1;
            if (questionNumber > 10 && questionNumber <= 20) partNumber = 2;
            else if (questionNumber > 20 && questionNumber <= 30) partNumber = 3;
            else if (questionNumber > 30) partNumber = 4;
            if (currentPart !== partNumber) {
                switchToPart(partNumber);
            }
            document.querySelectorAll('.subQuestion').forEach(btn => btn.classList.remove('active'));
            const questionBtn = document.querySelector(`.subQuestion[onclick="goToQuestion(${questionNumber})"]`);
            if (questionBtn) questionBtn.classList.add('active');

            // Scroll to the question
            let questionElement;
            if (questionNumber >= 18 && questionNumber <= 20) {
                questionElement = document.querySelector('input[name="q18-20"]');
            } else if (questionNumber >= 17 && questionNumber <= 18) {
                questionElement = document.querySelector('input[name="q17-18"]');
            } else if (questionNumber >= 19 && questionNumber <= 20) {
                questionElement = document.querySelector('input[name="q19-20"]');
            } else if (questionNumber >= 25 && questionNumber <= 30) {
                // For checkbox questions 25-30, find the first checkbox of the question
                questionElement = document.querySelector(`input[name="q${questionNumber}"]`);
            } else {
                questionElement = document.getElementById(`q${questionNumber}`) || // text inputs
                                document.querySelector(`[data-question-id="${questionNumber}"]`) || // drag-drop
                                document.querySelector(`input[name="q${questionNumber}"]`); // radio buttons
            }
            
            if (questionElement) {
                const questionContainer = questionElement.closest('.question');
                if(questionContainer) {
                    questionContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    questionContainer.classList.add('flash');
                    setTimeout(() => {
                        questionContainer.classList.remove('flash');
                    }, 1000);
                }
            }
            updateNavigation();
        }

        function nextPart() {
            if (currentQuestion < 40) {
                goToQuestion(currentQuestion + 1);
            }
        }

        function previousPart() {
            if (currentQuestion > 1) {
                goToQuestion(currentQuestion - 1);
            }
        }

        function highlightText() {
            if (!selectedRange || selectedRange.collapsed) {
                closeContextMenu();
                return;
            }
            
            try {
                // Check if selection spans multiple elements
                const startContainer = selectedRange.startContainer;
                const endContainer = selectedRange.endContainer;
                
                if (startContainer === endContainer && startContainer.nodeType === Node.TEXT_NODE) {
                    // Simple case: selection within a single text node
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    selectedRange.surroundContents(span);
                } else {
                    // Complex case: selection spans multiple elements
                    // Handle partial text selections and complex DOM structures
                    
                    // First, handle partial text at the start
                    const startOffset = selectedRange.startOffset;
                    const endOffset = selectedRange.endOffset;
                    
                    if (startContainer.nodeType === Node.TEXT_NODE && startOffset > 0) {
                        // Split the start text node if selection starts in the middle
                        const startText = startContainer.textContent;
                        const beforeText = startText.substring(0, startOffset);
                        const selectedStartText = startText.substring(startOffset);
                        
                        const beforeNode = document.createTextNode(beforeText);
                        const selectedNode = document.createTextNode(selectedStartText);
                        
                        const parent = startContainer.parentNode;
                        parent.insertBefore(beforeNode, startContainer);
                        parent.insertBefore(selectedNode, startContainer);
                        parent.removeChild(startContainer);
                        
                        // Update the range to start from the new node
                        selectedRange.setStart(selectedNode, 0);
                    }
                    
                    if (endContainer.nodeType === Node.TEXT_NODE && endOffset < endContainer.textContent.length) {
                        // Split the end text node if selection ends in the middle
                        const endText = endContainer.textContent;
                        const selectedEndText = endText.substring(0, endOffset);
                        const afterText = endText.substring(endOffset);
                        
                        const selectedNode = document.createTextNode(selectedEndText);
                        const afterNode = document.createTextNode(afterText);
                        
                        const parent = endContainer.parentNode;
                        parent.insertBefore(selectedNode, endContainer);
                        parent.insertBefore(afterNode, endContainer);
                        parent.removeChild(endContainer);
                        
                        // Update the range to end at the new node
                        selectedRange.setEnd(selectedNode, selectedNode.textContent.length);
                    }
                    
                    // Now extract the contents and highlight all text nodes
                    const fragment = selectedRange.extractContents();
                    
                    // Create a tree walker to find all text nodes
                    const walker = document.createTreeWalker(
                        fragment,
                        NodeFilter.SHOW_TEXT,
                        {
                            acceptNode: function(node) {
                                // Accept text nodes that have content (not just whitespace)
                                return node.textContent.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_SKIP;
                            }
                        },
                        false
                    );
                    
                    const textNodes = [];
                    let node;
                    while (node = walker.nextNode()) {
                        textNodes.push(node);
                    }
                    
                    // Wrap each text node in a highlight span
                    textNodes.forEach(textNode => {
                        const span = document.createElement('span');
                        span.className = 'highlight';
                        const parent = textNode.parentNode;
                        if (parent) {
                            parent.insertBefore(span, textNode);
                            span.appendChild(textNode);
                        }
                    });
                    
                    // Insert the highlighted fragment back
                    selectedRange.insertNode(fragment);
                }
            } catch(err) {
                console.warn('Primary highlighting failed, trying robust fallback:', err);
                
                // Robust fallback for complex selections
                try {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        
                        // Get all nodes in the selection
                        const startContainer = range.startContainer;
                        const endContainer = range.endContainer;
                        const commonAncestor = range.commonAncestorContainer;
                        
                        // Create a temporary range to work with
                        const tempRange = document.createRange();
                        tempRange.selectNodeContents(commonAncestor);
                        
                        // Find the start and end positions
                        const startPos = range.startOffset;
                        const endPos = range.endOffset;
                        
                        // Extract and highlight the content
                        const contents = range.extractContents();
                        
                        // Recursively highlight all text content
                        function highlightAllText(node) {
                            if (node.nodeType === Node.TEXT_NODE) {
                                if (node.textContent.trim()) {
                                    const span = document.createElement('span');
                                    span.className = 'highlight';
                                    span.style.backgroundColor = '#ffff00';
                                    const parent = node.parentNode;
                                    if (parent) {
                                        parent.insertBefore(span, node);
                                        span.appendChild(node);
                                    }
                                }
                            } else if (node.nodeType === Node.ELEMENT_NODE) {
                                Array.from(node.childNodes).forEach(child => {
                                    highlightAllText(child);
                                });
                            }
                        }
                        
                        highlightAllText(contents);
                        range.insertNode(contents);
                    }
                } catch(e2) {
                    console.warn('Robust fallback failed, using final method:', e2);
                    // Final fallback - use execCommand
                    try {
                        document.execCommand('backColor', false, 'yellow');
                    } catch(e3) {
                        console.error('All highlighting methods failed:', e3);
                        // Show user feedback
                        alert('Highlighting failed for this selection. Please try selecting smaller portions of text.');
                    }
                }
            }
            
            window.getSelection().removeAllRanges();
            closeContextMenu();
        }

        function addComment() {
            const commentText = prompt('Enter your comment:');
            if (!commentText || !selectedRange || selectedRange.collapsed) {
                closeContextMenu();
                return;
            }
            try {
                const span = document.createElement('span');
                span.className = 'comment-highlight';
                const tooltip = document.createElement('span');
                tooltip.className = 'comment-tooltip';
                tooltip.textContent = commentText;
                span.appendChild(tooltip);
                selectedRange.surroundContents(span);
            }catch(err){
                console.warn('Complex selection – cannot comment');
            }
            window.getSelection().removeAllRanges();
            closeContextMenu();
        }

        function clearHighlight() {
            const elementToClear = contextElement; // Set by contextmenu handler
            if (!elementToClear) {
                closeContextMenu();
                return;
            }

            const highlightId = elementToClear.getAttribute('data-highlight-id');
            const elementsToClear = highlightId
                ? Array.from(document.querySelectorAll(`[data-highlight-id="${highlightId}"]`))
                : [elementToClear];

            let commonParent = null;
            if (elementsToClear.length > 0) {
                commonParent = elementsToClear[0].parentNode;
            }

            elementsToClear.forEach(element => {
                const parent = element.parentNode;
                const fragment = document.createDocumentFragment();

                while (element.firstChild) {
                    // Don't keep the tooltip for comments. Just unwrap everything.
                    if (element.firstChild.nodeType === 1 && element.firstChild.classList.contains('comment-tooltip')) {
                        element.removeChild(element.firstChild);
                    } else {
                        fragment.appendChild(element.firstChild);
                    }
                }
                parent.replaceChild(fragment, element);
            });
            
            if (commonParent) {
                commonParent.normalize(); // Merges adjacent text nodes
            }
            
            closeContextMenu();
        }

        function clearAllHighlights() {
            document.querySelectorAll('.highlight, .comment-highlight').forEach(element => {
                const parent = element.parentNode;
                const fragment = document.createDocumentFragment();

                while (element.firstChild) {
                    if (element.firstChild.nodeType === 1 && element.firstChild.classList.contains('comment-tooltip')) {
                        element.removeChild(element.firstChild);
                    } else {
                        fragment.appendChild(element.firstChild);
                    }
                }
                parent.replaceChild(fragment, element);
            });
            closeContextMenu();
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextElement = null;
        }

        function updateAttemptedCount(partNumber) {
            const partContainer = document.getElementById(`part-${partNumber}`);
            if (!partContainer) return;
            const inputs = partContainer.querySelectorAll('input.answer-input:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled])');
            const selects = partContainer.querySelectorAll('select.answer-input:not([disabled]), select.answer-select:not([disabled])');
            let answeredCount = 0;
            const answeredGroups = {};
            
            inputs.forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    if (input.checked && !answeredGroups[input.name]) {
                        if (input.name === 'q13-14') {
                            const checkedCount = document.querySelectorAll('input[name="q13-14"]:checked').length;
                            answeredCount += checkedCount; // Add 1 or 2 depending on selections
                        } else if (input.type === 'checkbox' && (input.name.startsWith('q25') || input.name.startsWith('q26') || 
                                   input.name.startsWith('q27') || input.name.startsWith('q28') || 
                                   input.name.startsWith('q29') || input.name.startsWith('q30'))) {
                            // Handled below as paired checkbox questions (25-26, 27-28, 29-30). Do not increment here for checkboxes.
                        } else {
                            answeredCount++;
                        }
                        answeredGroups[input.name] = true;
                    }
                } else {
                    if (input.value.trim() !== '') answeredCount++;
                }
            });
            
            selects.forEach(select => {
                if (select.value !== '' && select.value !== 'Select') answeredCount++;
            });

            // Count drag-drop answers in summary drop zones (e.g., questions 15-20)
            const summaryZones = partContainer.querySelectorAll('.summary-drop-zone[data-question]');
            summaryZones.forEach(zone => {
                const qId = zone.getAttribute('data-question');
                if (!qId) return;
                if (zone.querySelector('.drag-item') && !answeredGroups[qId]) {
                    answeredCount++;
                    answeredGroups[qId] = true;
                }
            });

            // Count checkbox pairs for questions 25-30: +1 per selection up to 2 per pair
            const pairBases = ['q25', 'q27', 'q29'];
            pairBases.forEach(base => {
                const selected = partContainer.querySelectorAll(`input[name="${base}"]:checked`).length;
                answeredCount += Math.min(selected, 2);
            });
            
            // Count clickable cells for questions 15-20 and 25-30
            const clickableCells = partContainer.querySelectorAll('.clickable-cell[data-selected="true"]');
            clickableCells.forEach(cell => {
                const questionId = cell.getAttribute('data-question');
                if (questionId) {
                    const qNum = parseInt(questionId.replace('q', ''), 10);
                    // Only count if this question hasn't been counted yet
                    if (!answeredGroups[questionId]) {
                        answeredCount++;
                        answeredGroups[questionId] = true;
                    }
                }
            });
            
            const countDisplay = document.querySelector(`.footer__questionWrapper___1tZ46:nth-child(${partNumber}) .attemptedCount`);
            if (countDisplay) {
                countDisplay.textContent = `${answeredCount} of 10`;
                if (partNumber === 3) {
                    console.log(`🎯 Part 3 count updated: ${answeredCount} of 10`);
                }
            }
        }

        function checkAnswers() {
            let score = 0;
            let resultsData = [];
            const pairKeysAll = ['q25','q26','q27','q28','q29','q30'];
            const processedPairsScore = new Set();
            document.querySelectorAll('.correct, .incorrect, .correct-answer-text').forEach(el => el.classList.contains('correct-answer-text') ? el.remove() : el.classList.remove('correct', 'incorrect'));
            
            Object.keys(correctAnswers).forEach(key => {
                const qNum = parseInt(key.replace('q', ''), 10);

                const correctAnswer = correctAnswers[key];
                let userAnswer = '';
                let isCorrect = false;

                const questionType = questionTypes[key];
                let btn;
                
                btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${qNum})"]`);
                
                switch(questionType) {
                    case 'text':
                        const element = document.getElementById(key);
                        if (element) {
                            userAnswer = element.value.trim();
                            const acceptedAnswers = Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)];
                            isCorrect = acceptedAnswers.some(ans => ans.toLowerCase() === userAnswer.toLowerCase());
                            element.classList.add(isCorrect ? 'correct' : 'incorrect');
                            if (!isCorrect) {
                                const correctAnswerSpan = document.createElement('span');
                                correctAnswerSpan.className = 'correct-answer-text';
                                correctAnswerSpan.textContent = `(Correct: ${acceptedAnswers.join(' / ')})`;
                                element.parentNode.insertBefore(correctAnswerSpan, element.nextSibling);
                            }
                        }
                        break;
                    
                    case 'mcq':
                        const radioChecked = document.querySelector(`input[name="${key}"]:checked`);
                        userAnswer = radioChecked ? radioChecked.value : '';
                        isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                        const isTable = document.querySelector(`input[name="${key}"]`) ? document.querySelector(`input[name="${key}"]`).closest('.mcq-table') : false;

                        if (radioChecked) {
                            if (isTable) {
                                // For table MCQs, mark the row
                                const rowToMark = radioChecked.closest('tr');
                                if (rowToMark) {
                                    rowToMark.classList.add(isCorrect ? 'correct' : 'incorrect');
                                }
                            } else {
                                // For single-choice MCQs, mark the label
                                const labelToMark = radioChecked.closest('label');
                                if (labelToMark) {
                                    labelToMark.classList.add(isCorrect ? 'correct' : 'incorrect');
                                }
                            }
                        }
                        
                        if (!isCorrect) {
                            const correctRadio = document.querySelector(`input[name="${key}"][value="${correctAnswer}"]`);
                            if (correctRadio) {
                                if (isTable) {
                                    // For table MCQs, mark the correct row
                                    const correctRow = correctRadio.closest('tr');
                                    if (correctRow) {
                                        correctRow.classList.add('correct');
                                    }
                                } else {
                                    // For single-choice MCQs, mark the correct label
                                    const correctLabel = correctRadio.closest('label');
                                    if (correctLabel) {
                                        correctLabel.classList.add('correct');
                                    }
                                }
                            }
                        }
                        
                        // If no answer was selected, show the correct answer
                        if (!radioChecked) {
                            const correctRadio = document.querySelector(`input[name="${key}"][value="${correctAnswer}"]`);
                            if (correctRadio) {
                                const correctLabel = correctRadio.closest('label');
                                if (correctLabel) {
                                    correctLabel.classList.add('correct');
                                }
                            }
                        }
                        break;
                    
                    case 'clickable':
                        const selectedCell = document.querySelector(`.clickable-cell[data-question="${key}"][data-selected="true"]`);
                        if (selectedCell) {
                            userAnswer = selectedCell.getAttribute('data-answer');
                            isCorrect = userAnswer.toUpperCase() === correctAnswer.toUpperCase();
                            selectedCell.classList.add(isCorrect ? 'correct' : 'incorrect');
                            if (!isCorrect) {
                                const correctCell = document.querySelector(`.clickable-cell[data-question="${key}"][data-value="${correctAnswer}"]`);
                                if (correctCell) correctCell.classList.add('correct');
                            }
                        } else {
                            const correctCell = document.querySelector(`.clickable-cell[data-question="${key}"][data-value="${correctAnswer}"]`);
                            if (correctCell) correctCell.classList.add('correct');
                        }
                        break;
                    
                    case 'drag_drop':
                        // Support both older .drop-zone and new .summary-drop-zone for 15–20
                        let dropZone = document.querySelector(`.drop-zone[data-question-id="${qNum}"]`);
                        if (!dropZone) dropZone = document.querySelector(`.summary-drop-zone[data-question="q${qNum}"]`);
                        if (dropZone) {
                            const droppedItem = dropZone.querySelector('.drag-item');
                            if (droppedItem) {
                                // Prefer data-value if present; otherwise fall back to first letter
                                const dataValue = droppedItem.getAttribute('data-value');
                                if (dataValue) {
                                    userAnswer = dataValue.trim();
                                } else {
                                    const text = droppedItem.textContent.trim();
                                    userAnswer = text.charAt(0);
                                }
                            } else {
                                userAnswer = '';
                            }
                            const acceptedAnswers = Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)];
                            isCorrect = acceptedAnswers.some(ans => ans.toUpperCase() === userAnswer.toUpperCase());
                            dropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                            if (!isCorrect) {
                                const correctAnswerSpan = document.createElement('span');
                                correctAnswerSpan.className = 'correct-answer-text';
                                correctAnswerSpan.textContent = `(Correct: ${acceptedAnswers.join(' / ')})`;
                                dropZone.appendChild(correctAnswerSpan);
                            }
                        }
                        break;
                    
                    case 'select':
                        const selectElement = document.getElementById(key);
                        if (selectElement) {
                            userAnswer = selectElement.value;
                            const acceptedAnswers = Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)];
                            isCorrect = acceptedAnswers.some(ans => ans.toUpperCase() === userAnswer.toUpperCase());
                            selectElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                            if (!isCorrect) {
                                const correctAnswerSpan = document.createElement('span');
                                correctAnswerSpan.className = 'correct-answer-text';
                                correctAnswerSpan.textContent = `(Correct: ${acceptedAnswers.join(' / ')})`;
                                selectElement.parentNode.insertBefore(correctAnswerSpan, selectElement.nextSibling);
                            }
                        }
                        break;
                    
                    case 'checkbox':
                        // For 25-30 pair questions, alias even numbers to the previous odd so scoring uses same set
                        const aliasName = (key === 'q26') ? 'q25' : (key === 'q28') ? 'q27' : (key === 'q30') ? 'q29' : key;
                        const checkedBoxes = (key === 'q13' || key === 'q14')
                            ? document.querySelectorAll('input[name="q13-14"]:checked')
                            : document.querySelectorAll(`input[name="${aliasName}"]:checked`);
                        const userAnswers = Array.from(checkedBoxes).map(box => box.value).sort();
                        userAnswer = userAnswers.join(', ');
                        const correctAnswersArray = Array.isArray(correctAnswer) ? [...correctAnswer].sort() : [correctAnswer];
                        if (Array.isArray(correctAnswer) && correctAnswersArray.length > 1) {
                            // Full-credit only if both correct are selected
                            isCorrect = userAnswers.length === correctAnswersArray.length && userAnswers.every((ans, idx) => ans === correctAnswersArray[idx]);
                        } else {
                            isCorrect = userAnswers.includes(String(correctAnswer));
                        }

                        // Mark each checked box individually based on correctness
                        const allBoxesInGroup = (key === 'q13' || key === 'q14')
                            ? document.querySelectorAll('input[name="q13-14"]')
                            : document.querySelectorAll(`input[name="${aliasName}"]`);
                        allBoxesInGroup.forEach(box => {
                            const label = box.closest('label');
                            if (!label) return;
                            if (box.checked) {
                                if (correctAnswersArray.includes(box.value)) {
                                    label.classList.add('correct');
                                } else {
                                    label.classList.add('incorrect');
                                }
                            }
                        });

                        // Always highlight the correct answers (even if not selected)
                        correctAnswersArray.forEach(correctAns => {
                            const correctBox = (key === 'q13' || key === 'q14')
                                ? document.querySelector(`input[name="q13-14"][value="${correctAns}"]`)
                                : document.querySelector(`input[name="${aliasName}"][value="${correctAns}"]`);
                            if (correctBox) {
                                const correctLabel = correctBox.closest('label');
                                if (correctLabel) {
                                    correctLabel.classList.add('correct');
                                }
                            }
                        });
                        break;
                }

                // For 25-30 (pairs), award up to 2 points per pair: +1 per correct selection, 0 for wrong extras
                if (questionTypes[key] === 'checkbox' && (key === 'q25' || key === 'q26' || key === 'q27' || key === 'q28' || key === 'q29' || key === 'q30')) {
                    const pairKey = (key === 'q26') ? 'q25' : (key === 'q28') ? 'q27' : (key === 'q30') ? 'q29' : key;
                    if (!processedPairsScore.has(pairKey)) {
                        const correctSet = new Set(Array.isArray(correctAnswers[pairKey]) ? correctAnswers[pairKey] : [correctAnswers[pairKey]]);
                        const selected = Array.from(document.querySelectorAll(`input[name="${pairKey}"]:checked`)).map(b => b.value);
                        let gained = 0;
                        selected.forEach(v => { if (correctSet.has(v)) gained++; });
                        gained = Math.min(gained, correctSet.size);
                        score += gained;
                        processedPairsScore.add(pairKey);
                    }
                } else {
                    if (isCorrect) score++;
                }

                if (btn) {
                    btn.classList.remove('answered');
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                }

                resultsData.push({
                    question: qNum,
                    userAnswer: userAnswer || 'No Answer',
                    correctAnswer: Array.isArray(correctAnswer) ? correctAnswer.join(' / ') : String(correctAnswer),
                    isCorrect: isCorrect
                });
            });

            const deliverButton = document.getElementById('deliver-button');
            const band = (function(raw){
                if(raw>=39) return 9;
                if(raw>=37) return 8.5;
                if(raw>=35) return 8;
                if(raw>=32) return 7.5;
                if(raw>=30) return 7;
                if(raw>=26) return 6.5;
                if(raw>=23) return 6;
                if(raw>=18) return 5.5;
                if(raw>=16) return 5;
                if(raw>=13) return 4.5;
                if(raw>=10) return 4;
                if(raw>=8)  return 3.5;
                if(raw>=6)  return 3;
                if(raw>=4)  return 2.5;
                if(raw>=2)  return 2;
                if(raw===1) return 1.5;
                return 0;
            })(score);
            
            // Change button to "My Answers" and make it green
            deliverButton.innerHTML = `<i class="fa fa fa-check" aria-hidden="true"></i><span>My Answers</span>`;
            deliverButton.style.backgroundColor = '#28a745';
            deliverButton.style.color = 'white';
            deliverButton.style.borderColor = '#28a745';
            deliverButton.onclick = showResultsModal;
            
            // Store results for modal
            window.testResults = {
                score: score,
                band: band,
                resultsData: resultsData
            };
            document.querySelectorAll('.answer-input, input[type="radio"], input[type="checkbox"]').forEach(input => {
                input.disabled = true;
            });
            document.querySelectorAll('.drag-item').forEach(item => {
                item.setAttribute('draggable', 'false');
                item.style.cursor = 'default';
            });
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over'); // Ensure no lingering hover styles
            });

            document.querySelector('.main-container').classList.add('results-mode');
            switchToPart(currentPart); // Show the transcription for the current part

            // Populate and show modal
            const modal = document.getElementById('result-modal');
            const scoreSummary = document.getElementById('score-summary');
            const resultDetails = document.getElementById('result-details');
            
            scoreSummary.textContent = `You scored ${score} out of 40 (Band ${band}).`;
            
            let tableHTML = '<table><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>';
            resultsData.sort((a,b) => parseInt(a.question, 10) - parseInt(b.question, 10)).forEach(res => {
                tableHTML += `
                    <tr>
                        <td>${res.question}</td>
                        <td>${res.userAnswer}</td>
                        <td>${res.correctAnswer}</td>
                        <td class="${res.isCorrect ? 'result-correct' : 'result-incorrect'}">
                            ${res.isCorrect ? '✔ Correct' : '✖ Incorrect'}
                        </td>
                    </tr>
                `;
            });
            tableHTML += '</table>';
            resultDetails.innerHTML = tableHTML;

            modal.style.display = 'flex';
        }
        
        function showResultsModal() {
            if (!window.testResults) return;
            
            const { score, band, resultsData } = window.testResults;
            
            // Populate and show modal
            const modal = document.getElementById('result-modal');
            const scoreSummary = document.getElementById('score-summary');
            const resultDetails = document.getElementById('result-details');
            
            scoreSummary.textContent = `You scored ${score} out of 40 (Band ${band}).`;
            
            let tableHTML = '<table><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>';
            resultsData.sort((a,b) => parseInt(a.question, 10) - parseInt(b.question, 10)).forEach(res => {
                tableHTML += `
                    <tr>
                        <td>${res.question}</td>
                        <td>${res.userAnswer}</td>
                        <td>${res.correctAnswer}</td>
                        <td class="${res.isCorrect ? 'result-correct' : 'result-incorrect'}">
                            ${res.isCorrect ? '✔ Correct' : '✖ Incorrect'}
                        </td>
                    </tr>
                `;
            });
            tableHTML += '</table>';
            resultDetails.innerHTML = tableHTML;

            modal.style.display = 'flex';
        }
        
        function startTimer() {
            timerInterval = setInterval(() => {
                timeInSeconds--;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeInSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Time's up!";
                    checkAnswers();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // Event Listeners
        playPauseBtn.addEventListener('click', () => {
            if (!testStarted) {
                testStarted = true; // Timer removed, skip startTimer
                switchToPart(currentPart, true);
            } else {
                if (audioPlayer.paused) {
                    // If paused, ensure the audio source is for the current part
                    if (!audioPlayer.src.includes(audioSource)) {
                        audioPlayer.src = audioSource;
                    }
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            }
        });
        
        audioPlayer.addEventListener('play', () => {
            playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        });

        audioPlayer.addEventListener('pause', () => {
            playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        });

        audioPlayer.addEventListener('ended', () => {
            if (currentPart < 4) {
                switchToPart(currentPart + 1, true);
            }
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            progressBar.max = audioPlayer.duration;
            totalDurationEl.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('timeupdate', () => {
            progressBar.value = audioPlayer.currentTime;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        });

        progressBar.addEventListener('input', () => {
            audioPlayer.currentTime = progressBar.value;
        });

        volumeSlider.addEventListener('input', (e) => audioPlayer.volume = e.target.value);

        speedBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            speedOptions.classList.toggle('hidden');
        });

        speedOptions.addEventListener('click', (e) => {
            if (e.target.dataset.speed) {
                const speed = parseFloat(e.target.dataset.speed);
                audioPlayer.playbackRate = speed;
                speedBtn.textContent = `${speed}x`;
                speedOptions.classList.add('hidden');
            }
        });
        
        document.addEventListener('click', () => {
            if (!speedOptions.classList.contains('hidden')) {
                speedOptions.classList.add('hidden');
            }
        });

        document.getElementById('deliver-button').addEventListener('click', checkAnswers);
        
        // Go To Question Widget Logic
        const gotoWidget = document.getElementById('goto-widget');
        const gotoInput = document.getElementById('goto-input');
        const gotoBtn = document.getElementById('goto-btn');

        document.addEventListener('keydown', (e) => {
            if (e.key >= '0' && e.key <= '9' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                gotoWidget.classList.remove('hidden');
                gotoInput.focus();
                gotoInput.value = e.key;
            }
            if (e.key === 'Enter' && document.activeElement === gotoInput) {
                gotoBtn.click();
            }
            if (e.key === 'Escape') {
                gotoWidget.classList.add('hidden');
                gotoInput.value = '';
            }
        });

        if (gotoBtn) {
            gotoBtn.addEventListener('click', () => {
                const qNum = parseInt(gotoInput.value, 10);
                if (qNum >= 1 && qNum <= 40) {
                    goToQuestion(qNum);
                    gotoWidget.classList.add('hidden');
                    gotoInput.value = '';
                } else {
                    alert('Please enter a number between 1 and 40.');
                }
            });
        }

        // Add listener for the modal close button
        document.getElementById('modal-close-button').addEventListener('click', () => {
            document.getElementById('result-modal').style.display = 'none';
        });

        // === Tap-to-select & tap-to-drop for drag items (mobile support) ===
        document.body.addEventListener('click', function(e){
            const item = e.target.closest('.drag-item');
            if(item && item.getAttribute('draggable')){
                // Toggle selection
                document.querySelectorAll('.drag-item.selected').forEach(i=>i.classList.remove('selected'));
                item.classList.add('selected');
                draggedElement = item;
                return;
            }
            const dz = e.target.closest('.drop-zone');
            if(dz && draggedElement){
                // If already filled, move old back
                const optionsList = document.querySelector('.matching-options-list');
                if(dz.children.length>0 && dz.firstElementChild!==draggedElement){
                    optionsList.appendChild(dz.firstElementChild);
                }
                dz.appendChild(draggedElement);
                draggedElement.classList.remove('selected');
                draggedElement=null;
                updateAnsweredIndicators();
            }
        });

        // === Mobile highlight/comment toolbar ===
        const mobileToolbar = document.getElementById('mobile-selection-menu');
        function positionToolbar(){
            const sel = window.getSelection();
            if(sel.rangeCount===0 || sel.isCollapsed){
                mobileToolbar.classList.add('hidden');
                return;
            }
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            mobileToolbar.style.top = window.scrollY + rect.top - mobileToolbar.offsetHeight - 8 + 'px';
            mobileToolbar.style.left = window.scrollX + rect.left + 'px';
            mobileToolbar.classList.remove('hidden');
        }
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if(sel && sel.rangeCount>0 && !sel.isCollapsed){
                selectedRange = sel.getRangeAt(0);
                selectedText = sel.toString();
            }
            if('ontouchstart' in window || navigator.maxTouchPoints>0){
                setTimeout(positionToolbar, 0);
            }
        });
        document.addEventListener('click', (e)=>{
            if(!e.target.closest('#mobile-selection-menu')){
                mobileToolbar.classList.add('hidden');
            }
        });

        /* ---------------- Drag and Drop for Matching Questions ---------------- */

        (function initDragAndDrop() {
            const container = document.querySelector('.left-panel');
            if (!container) return;

            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('drag-item')) {
                    draggedElement = e.target;
                    setTimeout(() => {
                        e.target.classList.add('dragging');
                    }, 0);
                }
            });

            container.addEventListener('dragend', (e) => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const target = e.target;
                const dropZone = target.closest('.drop-zone');
                const optionsList = target.closest('.matching-options-list');

                if (dropZone || optionsList) {
                    const overElement = dropZone || optionsList;
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    overElement.classList.add('drag-over');
                }
            });

            container.addEventListener('dragleave', (e) => {
                const target = e.target;
                const dropZone = target.closest('.drop-zone');
                const optionsList = target.closest('.matching-options-list');
                if (dropZone || optionsList) {
                    const overElement = dropZone || optionsList;
                    overElement.classList.remove('drag-over');
                }
            });


            container.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const dropTarget = e.target.closest('.drop-zone, .matching-options-list');
                if (!dropTarget) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                    return;
                }

                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                const existingItem = dropTarget.matches('.drop-zone') ? dropTarget.querySelector('.drag-item') : null;
                const originalParent = draggedElement.parentNode;

                // If there's an item in the target dropzone, swap them
                if (existingItem) {
                    originalParent.appendChild(existingItem);
                }
                
                dropTarget.appendChild(draggedElement);

                if(dropTarget.matches('.drop-zone')) {
                    const placeholder = dropTarget.querySelector('.placeholder');
                    if (placeholder) placeholder.style.display = 'none';
                }

                draggedElement.classList.remove('dragging');
                draggedElement = null;
                updateAnsweredIndicators();
            });
        })();


        document.addEventListener('DOMContentLoaded', () => {
            switchToPart(1);
            goToQuestion(1);
            setupCheckboxLimits();
            
            // Initialize attempted counts for all parts
            updateAttemptedCount(1);
            updateAttemptedCount(2);
            updateAttemptedCount(3);
            updateAttemptedCount(4);

            document.body.addEventListener('contextmenu', function (e) {
                const text = window.getSelection().toString();
                if (!text) return;
                e.preventDefault();
                const menu = document.getElementById('contextMenu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.style.display = 'block';

                const target = e.target;
                const clearItem = document.getElementById('clear-item');
                contextElement = target.closest('.highlight, .comment-highlight');
                if(contextElement){
                    clearItem.style.display = 'block';
                } else {
                    clearItem.style.display = 'none';
                }
            });
            
            document.body.addEventListener('click', function(e) {
                if (e.target.closest('.context-menu')) return;
                document.getElementById('contextMenu').style.display = 'none';
            });
        });

        // Initial setup on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            updateAnsweredIndicators();
            // Ensure initial transcription shown for Part 1
            const src = document.querySelector('#transcription-data [data-part="1"]');
            const tgt = document.getElementById('transcription-text');
            if (src && tgt) tgt.innerHTML = src.innerHTML;
        });

        document.querySelectorAll('.mcq-table td').forEach(cell => {
            cell.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const radio = cell.querySelector('input[type="radio"]');
                    if (radio && !radio.disabled) {
                        radio.checked = true;
                    }
                }
            });
        });

        document.querySelectorAll('.answer-input, input[type="radio"], input[type="checkbox"], select.answer-input').forEach(input => {
            input.addEventListener('input', updateAnsweredIndicators);
            input.addEventListener('change', updateAnsweredIndicators);
            
            // For checkbox questions 25-30, also update attempted count
            if (input.type === 'checkbox' && (input.name.startsWith('q25') || input.name.startsWith('q26') || 
                input.name.startsWith('q27') || input.name.startsWith('q28') || 
                input.name.startsWith('q29') || input.name.startsWith('q30'))) {
                input.addEventListener('change', () => {
                    const qNum = parseInt(input.name.replace('q', ''), 10);
                    updateAttemptedCount(3); // Part 3
                });
            }
        });

        function initAllDragAndDrop() {
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');

            dragItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });

            function handleDragStart(e) {
                draggedElement = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }

            function handleDragEnd(e) {
                e.target.classList.remove('dragging');
            }

            function handleDragOver(e) {
                e.preventDefault();
                const zone = e.target.closest('.drop-zone');
                if (zone) zone.classList.add('drag-over');
            }

            function handleDragLeave(e) {
                const zone = e.target.closest('.drop-zone');
                if (zone) zone.classList.remove('drag-over');
            }

            function handleDrop(e) {
                e.preventDefault();
                const targetZone = e.target.closest('.drop-zone');
                if (!targetZone || !draggedElement) return;
                
                targetZone.classList.remove('drag-over');

                const sourceContainer = draggedElement.parentNode;
                const itemInTargetZone = targetZone.querySelector('.drag-item');
                
                // Prevent dropping on self or non-droppable area inside zone
                if (e.target.classList.contains('drag-item') && e.target !== draggedElement) {
                    return; // Or handle swap explicitly here if needed
                }
                
                if (itemInTargetZone && itemInTargetZone !== draggedElement) {
                    // If source is an options list, move the existing item back
                    const optionsList = findParentOptionsList(targetZone);
                    if (sourceContainer.classList.contains('matching-options-list') || sourceContainer.classList.contains('map-options-list')) {
                    optionsList.appendChild(itemInTargetZone);
                    } 
                    // If source is another drop zone (swapping)
                    else if (sourceContainer.classList.contains('drop-zone')) {
                        sourceContainer.appendChild(itemInTargetZone);
                    }
                }

                targetZone.appendChild(draggedElement);
                if (targetZone.querySelector('.placeholder')) {
                    targetZone.querySelector('.placeholder').style.display = 'none';
                }
                
                updateAnsweredIndicators();
            }

            function findParentOptionsList(element) {
                // Specific for map
                if (element.closest('#map-drag-container')) {
                    return document.getElementById('map-options-q11-15');
                }
                // Generic for matching
                const container = element.closest('.matching-container');
                if (container) {
                    return container.querySelector('.matching-options-list');
                }
                return null;
            }
        }

        let transcriptionHighlighted = false;
        function highlightAnswersInTranscription() {
            if (transcriptionHighlighted) return;

            const highlightedTranscripts = { 1: '', 2: '', 3: '', 4: '' };

            for (let i = 1; i <= 4; i++) {
                const partElement = document.querySelector(`#transcription-data [data-part="${i}"]`);
                if (partElement) highlightedTranscripts[i] = partElement.innerHTML;
            }

            for (const key in correctAnswers) {
                const answers = Array.isArray(correctAnswers[key]) ? correctAnswers[key] : [correctAnswers[key]];
                if (answers.every(answer => /^[A-G]$/.test(answer))) {
                    continue;
                }

                const qNum = parseInt(key.match(/\d+/)[0]);
                let partNumber = 1;
                if (qNum > 10 && qNum <= 20) partNumber = 2;
                else if (qNum > 20 && qNum <= 30) partNumber = 3;
                else if (qNum > 30) partNumber = 4;

                if (!highlightedTranscripts[partNumber]) continue;

                let answersToHighlight = correctAnswers[key];
                if (!Array.isArray(answersToHighlight)) {
                    answersToHighlight = [answersToHighlight];
                }

                for (const answer of answersToHighlight) {
                    if (/^[A-G]$/.test(answer)) continue;
                    
                    let searchTerm = answer.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    searchTerm = searchTerm.replace(/\\\(s\\\)/g, '(s)?');
                    
                    const regex = new RegExp(`\\b(${searchTerm})\\b`, 'gi');
                    
                    highlightedTranscripts[partNumber] = highlightedTranscripts[partNumber].replace(
                        regex,
                        '<span class="highlight">$1</span>'
                    );
                }
            }

            for (let i = 1; i <= 4; i++) {
                const partElement = document.querySelector(`#transcription-data [data-part="${i}"]`);
                if(partElement) partElement.innerHTML = highlightedTranscripts[i];
            }
            transcriptionHighlighted = true;
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextElement = null;
        }
        
        // Function to limit checkbox selections
        window.limitCheckboxes = function(checkbox, name, maxSelections) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
            const checkedBoxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            
            if (checkedBoxes.length > maxSelections) {
                // If we're over the limit, uncheck the current checkbox
                checkbox.checked = false;
                return;
            }
            
            // Force update both functions to ensure proper counting
            updateAnsweredIndicators();
            
            // Update the attempted count for the current part
            const qNum = parseInt(name.replace('q', ''), 10);
            let partNumber = 1;
            if (qNum > 10 && qNum <= 20) partNumber = 2;
            else if (qNum > 20 && qNum <= 30) partNumber = 3;
            else if (qNum > 30) partNumber = 4;
            
            updateAttemptedCount(partNumber);
            
            if (qNum >= 25 && qNum <= 30) {
                console.log(`📝 Q${qNum} updated: ${checkedBoxes.length} selected`);
            }
        };
        
        // Global function for selecting cells in tables
        window.selectCell = function(cell, questionId, value) {
            // Remove selected from row
            const row = cell.closest('tr');
            row.querySelectorAll('.clickable-cell').forEach(c => c.classList.remove('selected'));
            // Mark cell
            cell.classList.add('selected');
            cell.setAttribute('data-selected','true');
            cell.setAttribute('data-answer',value);
            updateAnsweredIndicators();
        };
        
        // Drag and Drop Functions for Questions 15-20
        function drag(event) {
            // Store both the value and the full text content
            const dragItem = event.target.closest('.drag-item');
            if (!dragItem) return;
            event.dataTransfer.setData("text", dragItem.dataset.value);
            event.dataTransfer.setData("fullText", dragItem.innerHTML);
            event.dataTransfer.setData("dragItemId", dragItem.dataset.value);
            dragItem.classList.add('dragging');
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function drop(event) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            const draggedValue = event.dataTransfer.getData("text");
            const fullText = event.dataTransfer.getData("fullText");
            const dragItemId = event.dataTransfer.getData("dragItemId");
            
            // Remove drag-over styling
            dropZone.classList.remove('drag-over');
            
            // If there is an existing answer here, return it to the options list
            const existingItem = dropZone.querySelector('.drag-item');
            if (existingItem) {
                const existingId = existingItem.getAttribute('data-value');
                returnOptionToOptionsList(existingId);
            }

            // Clear existing content
            dropZone.innerHTML = '';
            
            // Create and add the dragged item, showing only the option text (no leading letter)
            const draggedItem = document.createElement('div');
            draggedItem.className = 'drag-item';
            let displayText = fullText;
            if (dropZone.classList.contains('summary-drop-zone')) {
                const temp = document.createElement('div');
                temp.innerHTML = fullText;
                const plain = (temp.textContent || temp.innerText || '').trim();
                displayText = plain.replace(/^[A-Ha-h]\s*[\.)-]?\s*/, '');
            }
            draggedItem.textContent = displayText;
            draggedItem.setAttribute('data-value', draggedValue);
            draggedItem.style.cursor = 'default';
            
            // Keep content inline like text in an input-style box
            draggedItem.style.cssText = '';
            
            // Add remove functionality on click to send back to list
            draggedItem.addEventListener('click', function() {
                // Return the option back to the options list
                returnOptionToOptionsList(dragItemId, fullText);

                // Reset the drop zone number
                const questionNumber = dropZone.getAttribute('data-question').replace('q', '');
                dropZone.classList.remove('filled');
                dropZone.innerHTML = `<span>${questionNumber}</span>`;

                updateAnsweredIndicators();
            });
            
            dropZone.appendChild(draggedItem);
            dropZone.classList.add('filled');
            
            // Remove the option from the options list
            console.log('Attempting to remove option:', dragItemId); // Debug log
            removeOptionFromOptionsList(dragItemId);
            
            // Update answered indicators
            updateAnsweredIndicators();
        }

        // Allow dragging items back to the options list
        function dropBackToOptions(event) {
            event.preventDefault();
            const container = event.currentTarget;
            const draggedValue = event.dataTransfer.getData("text");
            const fullText = event.dataTransfer.getData("fullText");
            const dragItemId = event.dataTransfer.getData("dragItemId");

            // If this option was hidden in the list, show it again
            const optionElement = container.querySelector(`.drag-item[data-value="${dragItemId}"]`);
            if (optionElement) {
                optionElement.style.display = 'block';
                optionElement.removeAttribute('data-used');
            }

            // Find any drop zone currently holding this option and reset it
            const occupiedDrop = document.querySelector(`.summary-drop-zone .drag-item[data-value="${dragItemId}"]`);
            if (occupiedDrop) {
                const dz = occupiedDrop.closest('.summary-drop-zone');
                const q = dz.getAttribute('data-question').replace('q','');
                dz.classList.remove('filled');
                dz.innerHTML = `<span>${q}</span>`;
            }

            updateAnsweredIndicators();
        }
        
        // Function to remove option from options list
        function removeOptionFromOptionsList(optionId) {
            // Look for the option in the current part's drag options container
            const currentPart = document.querySelector('.question-part:not(.hidden)');
            const optionElement = currentPart ? currentPart.querySelector(`.drag-options-container .drag-item[data-value="${optionId}"]`) : null;
            
            if (optionElement) {
                optionElement.style.display = 'none';
                optionElement.setAttribute('data-used', 'true');
                console.log('Hidden option:', optionId); // Debug log
            } else {
                console.log('Option not found:', optionId); // Debug log
                // Fallback: try to find it anywhere
                const fallbackElement = document.querySelector(`.drag-options-container .drag-item[data-value="${optionId}"]`);
                if (fallbackElement) {
                    fallbackElement.style.display = 'none';
                    fallbackElement.setAttribute('data-used', 'true');
                    console.log('Hidden option (fallback):', optionId); // Debug log
                }
            }
        }
        
        // Function to return option back to options list
        function returnOptionToOptionsList(optionId, fullText) {
            // Look for the option in the current part's drag options container
            const currentPart = document.querySelector('.question-part:not(.hidden)');
            const optionElement = currentPart ? currentPart.querySelector(`.drag-options-container .drag-item[data-value="${optionId}"]`) : null;
            
            if (optionElement) {
                optionElement.style.display = 'block';
                optionElement.removeAttribute('data-used');
                console.log('Showed option:', optionId); // Debug log
            } else {
                console.log('Option not found for return:', optionId); // Debug log
                // Fallback: try to find it anywhere
                const fallbackElement = document.querySelector(`.drag-options-container .drag-item[data-value="${optionId}"]`);
                if (fallbackElement) {
                    fallbackElement.style.display = 'block';
                    fallbackElement.removeAttribute('data-used');
                    console.log('Showed option (fallback):', optionId); // Debug log
                }
            }
        }
        
        // Add event listeners for drag and drop when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add drag end event to remove dragging class
            document.addEventListener('dragend', function(event) {
                if (event.target.classList.contains('drag-item')) {
                    event.target.classList.remove('dragging');
                }
            });
            
            // Add specific event listeners for radio buttons to ensure they trigger updateAnsweredIndicators
            for (let i = 21; i <= 26; i++) {
                const radioButtons = document.querySelectorAll(`input[name="q${i}"]`);
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        console.log(`Radio button changed for q${i}: ${this.value}`);
                        updateAnsweredIndicators();
                    });
                });
            }
        });
    </script>
</body>
</html>
